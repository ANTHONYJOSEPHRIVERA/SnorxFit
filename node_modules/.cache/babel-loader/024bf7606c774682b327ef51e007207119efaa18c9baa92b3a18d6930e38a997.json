{"ast":null,"code":"var _jsxFileName = \"C:\\\\xampp\\\\htdocs\\\\FICTIA\\\\src\\\\components\\\\Chatbot.js\",\n  _s = $RefreshSig$();\nimport React, { useState, useEffect, useRef } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { MessageSquare, Send, ArrowLeft, Sparkles, Plus, Trash2, MessageCircle } from 'lucide-react';\nimport ReactMarkdown from 'react-markdown';\nimport remarkGfm from 'remark-gfm';\nimport { chatWithGemini, logChatMetric } from '../utils/api';\nimport { useAuth } from '../contexts/AuthContext';\nimport { doc, getDoc, collection, addDoc, query, orderBy, limit, getDocs, deleteDoc, updateDoc, serverTimestamp } from 'firebase/firestore';\nimport { db } from '../config/firebase';\nimport { ALIMENTOS_DB } from '../data/foodDatabase';\nimport { foodCategories } from '../data/foodGallery';\nimport { getUserPreferences, generatePersonalizedContext, analyzeUserPreferences } from '../utils/userAnalytics';\n\n// ğŸ FUNCIÃ“N: Buscar alimentos en la galerÃ­a local\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst searchFoodInLocal = searchTerm => {\n  const term = searchTerm.toLowerCase().trim();\n  const results = [];\n  foodCategories.forEach(category => {\n    category.items.forEach(food => {\n      var _food$aliases, _food$tags;\n      // Buscar por nombre, aliases o tags\n      const matchesName = food.name.toLowerCase().includes(term);\n      const matchesAlias = (_food$aliases = food.aliases) === null || _food$aliases === void 0 ? void 0 : _food$aliases.some(alias => alias.toLowerCase().includes(term));\n      const matchesTag = (_food$tags = food.tags) === null || _food$tags === void 0 ? void 0 : _food$tags.some(tag => tag.toLowerCase().includes(term));\n      if (matchesName || matchesAlias || matchesTag) {\n        results.push({\n          ...food,\n          categoryName: category.name\n        });\n      }\n    });\n  });\n  return results;\n};\n\n// ğŸ½ï¸ FUNCIÃ“N: Generar respuesta nutricional desde base de datos local\nconst getFoodNutritionFromLocal = userInput => {\n  const input = userInput.toLowerCase().trim();\n\n  // Extraer posible nombre de alimento\n  let searchTerm = input;\n\n  // Remover palabras comunes de preguntas\n  searchTerm = searchTerm.replace(/cuÃ¡nto|cuanto|tiene|contiene|informaciÃ³n|info|dame|dime|sobre|del|de|la|el|un|una|nutriciÃ³n|nutricional|calorÃ­as|calorias|proteÃ­nas|proteinas|carbohidratos|grasas/g, '').trim();\n  if (!searchTerm || searchTerm.length < 3) {\n    return null; // Muy corto para buscar\n  }\n  const results = searchFoodInLocal(searchTerm);\n  if (results.length === 0) {\n    return null; // No encontrado, dejar que Gemini responda\n  }\n\n  // Si encontramos resultados\n  if (results.length === 1) {\n    const food = results[0];\n    return `${food.icon} **${food.name}** (${food.categoryName})\n\nğŸ“Š **InformaciÃ³n nutricional** (por 100g):\nâ€¢ ğŸ”¥ CalorÃ­as: ${food.calories} kcal\nâ€¢ ğŸ’ª ProteÃ­nas: ${food.protein}g\nâ€¢ ğŸ Carbohidratos: ${food.carbs}g\nâ€¢ ğŸ¥‘ Grasas: ${food.fat}g\n\nâœ… Esta informaciÃ³n viene de nuestra base de datos local.`;\n  }\n\n  // MÃºltiples resultados\n  let response = `ğŸ” EncontrÃ© **${results.length} alimentos** que coinciden:\\n\\n`;\n  results.slice(0, 5).forEach(food => {\n    response += `${food.icon} **${food.name}** - ${food.calories} kcal | P:${food.protein}g C:${food.carbs}g G:${food.fat}g\\n`;\n  });\n  if (results.length > 5) {\n    response += `\\n...y ${results.length - 5} mÃ¡s. SÃ© mÃ¡s especÃ­fico para ver detalles.`;\n  }\n  return response;\n};\n\n// FunciÃ³n helper para obtener fecha local\nconst getLocalDateString = () => {\n  const now = new Date();\n  const year = now.getFullYear();\n  const month = String(now.getMonth() + 1).padStart(2, '0');\n  const day = String(now.getDate()).padStart(2, '0');\n  return `${year}-${month}-${day}`;\n};\n\n// ğŸ›¡ï¸ SISTEMA DE DETECCIÃ“N DE PREGUNTAS DE RIESGO\nconst detectRiskQuestion = userInput => {\n  const input = userInput.toLowerCase().trim();\n\n  // Patrones de riesgo extremo\n  const riskPatterns = {\n    pesoRapido: /(?:bajar|perder|adelgazar|quemar)\\s*(?:rÃ¡pido|rapido|rÃ¡pidamente|rapidamente)?\\s*(?:\\d+\\s*kg|\\d+\\s*kilos?)\\s*(?:en|por)\\s*(?:una?\\s*semana|dÃ­as?|dia)/i,\n    pesoExtremo: /(?:bajar|perder)\\s*(?:10|15|20|\\d{2})\\s*(?:kg|kilos?)\\s*(?:rÃ¡pido|rapido|en\\s*\\d+\\s*(?:semana|dÃ­a|mes))/i,\n    eliminarGrupo: /(?:dejar|eliminar|quitar|no\\s*comer|sin)\\s*(?:de\\s*comer\\s*)?(?:carbohidratos?|carbs|pan|arroz|grasas?|proteÃ­nas?|comida)/i,\n    ayunoExtremo: /(?:no\\s*comer|dejar\\s*de\\s*comer|ayunar)\\s*(?:nada|todo\\s*el\\s*dÃ­a|varios?\\s*dÃ­as?|una?\\s*semana)/i,\n    caloriasExtremas: /(?:comer|consumir)?\\s*(?:solo|menos\\s*de|mÃ¡ximo)?\\s*(?:500|600|700|800|900|1000)\\s*(?:kcal|calorÃ­as?|calorias?)/i,\n    ejercicioExtremo: /(?:hacer|entrenar)\\s*(?:mucho|demasiado|todo\\s*el\\s*dÃ­a|\\d+\\s*horas?)\\s*(?:ejercicio|cardio|gym)/i,\n    laxantesSupresores: /(?:pastillas?|suplementos?|medicamentos?)\\s*(?:para|de)?\\s*(?:adelgazar|bajar|perder|quemar)/i,\n    saltarComidas: /(?:saltar|no\\s*comer|omitir)\\s*(?:el\\s*)?(?:desayuno|almuerzo|cena|comidas?)/i,\n    vomito: /(?:vomitar|purgar|laxantes?)\\s*(?:despuÃ©s|para)/i,\n    trastorno: /(?:anorexia|bulimia|atracÃ³n|trastorno\\s*alimenticio)/i\n  };\n\n  // Verificar cada patrÃ³n\n  for (const [tipo, pattern] of Object.entries(riskPatterns)) {\n    if (pattern.test(input)) {\n      console.log('ğŸš¨ ALERTA DE RIESGO DETECTADA:', tipo);\n      return {\n        hasRisk: true,\n        riskType: tipo,\n        pattern: input\n      };\n    }\n  }\n  return {\n    hasRisk: false\n  };\n};\n\n// ğŸš¨ RESPUESTA PARA PREGUNTAS DE RIESGO\nconst getRiskWarningResponse = (riskType, userInput) => {\n  let warning = `ğŸš¨ **Ey, para el carro un momento...**\\n\\n`;\n  if (riskType === 'pesoRapido' || riskType === 'pesoExtremo') {\n    warning += `Hermano/a, lo que estÃ¡s preguntando es **peligroso** para tu salud. DÃ©jame explicarte por quÃ©:\\n\\n`;\n    warning += `**âŒ Bajar mucho peso muy rÃ¡pido causa:**\\n`;\n    warning += `â€¢ Pierdes MÃšSCULO, no solo grasa ğŸ’€\\n`;\n    warning += `â€¢ Tu metabolismo se jode permanentemente ğŸ”¥\\n`;\n    warning += `â€¢ Te vas a sentir horrible: cansancio, mareos, mal humor\\n`;\n    warning += `â€¢ Efecto rebote SEGURO: recuperas todo + kilos extra ğŸ“ˆ\\n\\n`;\n    warning += `**âœ… Mejor hagÃ¡moslo bien:**\\n`;\n    warning += `â€¢ 0.5-1 kg por semana (es lo saludable) ğŸ“Š\\n`;\n    warning += `â€¢ DÃ©ficit suave: -300 a -500 kcal al dÃ­a\\n`;\n    warning += `â€¢ Mete harta proteÃ­na para mantener mÃºsculo ğŸ’ª\\n`;\n    warning += `â€¢ Entrena con pesas 3-4 veces/semana\\n\\n`;\n    warning += `ğŸ’¡ **La neta:** Bajar rÃ¡pido = recuperar TODO mÃ¡s rÃ¡pido. Mejor lento y seguro, Â¿va?\\n\\n`;\n    warning += `Â¿Quieres que te arme un plan **sostenible** en lugar de algo extremo? ğŸ¯`;\n  } else if (riskType === 'eliminarGrupo') {\n    warning += `Mira bro/sis, entiendo que quieras resultados rÃ¡pidos, pero **eliminar grupos alimenticios completos es mala idea**. Te explico:\\n\\n`;\n    warning += `**âŒ Por quÃ© NO eliminarlos:**\\n\\n`;\n    warning += `ğŸ **Carbohidratos:**\\n`;\n    warning += `â€¢ Tu cerebro y mÃºsculos los NECESITAN para energÃ­a\\n`;\n    warning += `â€¢ Sin ellos: cansancio, mal humor, cero fuerza en el gym\\n`;\n    warning += `â€¢ Mejor: modera el arroz blanco, pero no lo elimines\\n\\n`;\n    warning += `ğŸ¥‘ **Grasas:**\\n`;\n    warning += `â€¢ Esenciales para tus hormonas (incluyendo testosterona)\\n`;\n    warning += `â€¢ Ayudan a absorber vitaminas\\n`;\n    warning += `â€¢ Mejor: palta, aceite de oliva, frutos secos\\n\\n`;\n    warning += `ğŸ¥© **ProteÃ­nas:**\\n`;\n    warning += `â€¢ Son TU MÃšSCULO literal\\n`;\n    warning += `â€¢ Sin ellas pierdes mÃºsculo, no grasa\\n\\n`;\n    warning += `**âœ… El truco real:**\\n`;\n    warning += `â€¢ Come TODO pero en las cantidades correctas ğŸ“\\n`;\n    warning += `â€¢ ProteÃ­na alta, carbos moderados, grasas necesarias\\n`;\n    warning += `â€¢ AsÃ­ mantienes mÃºsculo y quemas grasa ğŸ”¥\\n\\n`;\n    warning += `ï¿½ Â¿Te ayudo a balancear tu alimentaciÃ³n sin restricciones locas?`;\n  } else if (riskType === 'ayunoExtremo' || riskType === 'saltarComidas') {\n    warning += `Bro/sis, lo que estÃ¡s pensando hacer va a **joder tu metabolismo** mal. Te cuento por quÃ©:\\n\\n`;\n    warning += `**âŒ No comer = NO es la soluciÃ³n:**\\n`;\n    warning += `â€¢ Tu cuerpo entra en \"modo ahorro\" = quema MENOS calorÃ­as ğŸŒ\\n`;\n    warning += `â€¢ Pierdes mÃºsculo (que es lo que quema grasa)\\n`;\n    warning += `â€¢ Te sientes de la ver**: fatiga, irritabilidad, cero concentraciÃ³n\\n`;\n    warning += `â€¢ Terminas con atracones despuÃ©s (pregÃºntale a cualquiera)\\n\\n`;\n    warning += `**âœ… Lo que realmente funciona:**\\n`;\n    warning += `â€¢ Come 3-4 veces al dÃ­a, comidas normales âœ…\\n`;\n    warning += `â€¢ MÃ­nimo: 1200 kcal mujeres / 1500 kcal hombres\\n`;\n    warning += `â€¢ Desayuna bien = energÃ­a para todo el dÃ­a ğŸŒ…\\n`;\n    warning += `â€¢ ProteÃ­na en cada comida = no tienes hambre\\n\\n`;\n    warning += `ğŸ’¡ **Real talk:** No comer no te hace bajar de peso. Comer BIEN sÃ­.\\n\\n`;\n    warning += `Â¿Armamos un plan de comidas que realmente funcione? ğŸ½ï¸`;\n  } else if (riskType === 'caloriasExtremas') {\n    warning += `Ey ey ey, **esas calorÃ­as son DEMASIADO bajas** para cualquier persona. AsÃ­ no se hace, hermano/a:\\n\\n`;\n    warning += `**âŒ Menos de 1200 kcal es peligroso porque:**\\n`;\n    warning += `â€¢ No cubres ni lo BÃSICO que tu cuerpo necesita para funcionar ğŸ«€\\n`;\n    warning += `â€¢ Tu mÃºsculo se va a la mie*** (literal)\\n`;\n    warning += `â€¢ Cansancio extremo, frÃ­o todo el tiempo\\n`;\n    warning += `â€¢ Tu sistema inmune se debilita = te enfermas mÃ¡s\\n`;\n    warning += `â€¢ Las chicas pueden perder su perÃ­odo ğŸ˜°\\n\\n`;\n    warning += `**âœ… CalorÃ­as mÃ­nimas saludables:**\\n`;\n    warning += `â€¢ Mujeres: 1200-1500 kcal (mÃ­nimo)\\n`;\n    warning += `â€¢ Hombres: 1500-1800 kcal (mÃ­nimo)\\n`;\n    warning += `â€¢ Si entrenas: suma 300-500 kcal mÃ¡s\\n\\n`;\n    warning += `ğŸ’¡ Tu cuerpo no es tu enemigo. Dale lo que necesita y verÃ¡s resultados REALES.\\n\\n`;\n    warning += `Â¿Calculamos TUS calorÃ­as correctas? ğŸ“Š`;\n  } else if (riskType === 'ejercicioExtremo') {\n    warning += `Tranqui campeÃ³n/a, **entrenar de mÃ¡s es TAN malo como no entrenar**. Te cuento:\\n\\n`;\n    warning += `**âŒ Sobreentrenamiento causa:**\\n`;\n    warning += `â€¢ Lesiones por fatiga crÃ³nica ğŸ¤•\\n`;\n    warning += `â€¢ Pierdes mÃºsculo en lugar de ganarlo\\n`;\n    warning += `â€¢ Sistema inmune dÃ©bil = te enfermas\\n`;\n    warning += `â€¢ Insomnio, ansiedad, mal humor ğŸ˜´\\n`;\n    warning += `â€¢ Cero progreso (estancamiento total)\\n\\n`;\n    warning += `**âœ… Volumen Ã“PTIMO (probado):**\\n`;\n    warning += `â€¢ Pesas: 3-5 dÃ­as/semana, 45-60 minutos\\n`;\n    warning += `â€¢ Cardio: 2-3 dÃ­as/semana, 30-40 minutos\\n`;\n    warning += `â€¢ Descanso: 1-2 dÃ­as OBLIGATORIOS\\n`;\n    warning += `â€¢ Dormir: 7-9 horas (ahÃ­ crece el mÃºsculo) ğŸ˜´\\n\\n`;\n    warning += `ğŸ’¡ **Real:** El mÃºsculo crece cuando descansas, no cuando entrenas.\\n\\n`;\n    warning += `Â¿Quieres un plan de entreno balanceado que funcione? ğŸ’ª`;\n  } else if (riskType === 'laxantesSupresores' || riskType === 'vomito' || riskType === 'trastorno') {\n    warning += `ğŸ†˜ **Hermano/a, esto es SERIO. Necesito que me escuches:**\\n\\n`;\n    warning += `Lo que estÃ¡s preguntando es **extremadamente peligroso** y puede:\\n\\n`;\n    warning += `âŒ DaÃ±ar tu sistema digestivo de forma PERMANENTE\\n`;\n    warning += `âŒ Causarte problemas cardÃ­acos (desbalance electrolÃ­tico)\\n`;\n    warning += `âŒ Arruinar tus dientes para siempre\\n`;\n    warning += `âŒ Desarrollar trastornos alimenticios serios\\n`;\n    warning += `âŒ Afectar tu salud mental gravemente\\n\\n`;\n    warning += `**ğŸ†˜ Por favor, busca ayuda profesional:**\\n\\n`;\n    warning += `Esto suena mÃ¡s serio de lo que yo puedo manejar. Necesitas hablar con:\\n`;\n    warning += `â€¢ Un nutricionista certificado\\n`;\n    warning += `â€¢ Un psicÃ³logo especializado\\n`;\n    warning += `â€¢ Tu mÃ©dico de cabecera\\n\\n`;\n    warning += `ğŸ“ **LÃ­neas de ayuda en PerÃº (confidencial):**\\n`;\n    warning += `â€¢ EsSalud: **107** (gratis, 24/7)\\n`;\n    warning += `â€¢ MINSA Salud Mental: **(01) 284-1349**\\n\\n`;\n    warning += `ğŸ’™ **Te lo digo en serio:** Tu salud vale MIL VECES mÃ¡s que cualquier nÃºmero en la balanza.\\n\\n`;\n    warning += `No estÃ¡s solo/a en esto. Hay profesionales que pueden ayudarte de verdad. ğŸ¤`;\n    return warning;\n  }\n  warning += `\\n\\nâš ï¸ Ojo: Esto es orientaciÃ³n general. Si tienes dudas mÃ©dicas serias, siempre consulta con un profesional.\\n`;\n  return warning;\n};\n\n// ğŸ§  SISTEMA DE RESPUESTAS INTELIGENTES LOCALES\nconst getLocalResponse = (userInput, userFoodData, userProfile) => {\n  const input = userInput.toLowerCase().trim();\n  console.log('ğŸ” Analizando mensaje:', input);\n\n  // ===== 0. VERIFICAR PREGUNTAS DE RIESGO PRIMERO =====\n  const riskCheck = detectRiskQuestion(input);\n  if (riskCheck.hasRisk) {\n    console.log('ğŸš¨ Pregunta de RIESGO detectada:', riskCheck.riskType);\n    return getRiskWarningResponse(riskCheck.riskType, input);\n  }\n\n  // ===== 1. ANÃLISIS DE ALIMENTACIÃ“N =====\n  const preguntaSobreComida = input.includes('comÃ­') || input.includes('comi') || input.includes('estÃ¡ bien') || input.includes('esta bien') || input.includes('cÃ³mo voy') || input.includes('como voy') || input.includes('quÃ© tal') || input.includes('que tal') || input.includes('opiniÃ³n') || input.includes('opinion') || input.includes('hoy') && (input.includes('dÃ­a') || input.includes('dia')) || input.includes('alimentaciÃ³n') || input.includes('alimentacion') || input.includes('registro');\n  if (preguntaSobreComida) {\n    console.log('âœ… Detectado: pregunta sobre alimentaciÃ³n');\n    if (!userFoodData || !userFoodData.meals) {\n      return `ğŸ“‹ AÃºn no has registrado nada hoy.\\n\\n1. Ve a \"Registro de Alimentos\"\\n2. Agrega lo que comiste\\n3. Presiona \"Guardar Todo\"\\n4. Vuelve y pregÃºntame de nuevo ğŸ˜Š`;\n    }\n    const allFoods = Object.values(userFoodData.meals).flat();\n    if (allFoods.length === 0) {\n      return `ğŸ“‹ AÃºn no has registrado comidas hoy.\\n\\n1. Ve a \"Registro de Alimentos\"\\n2. Agrega lo que comiste\\n3. Presiona \"Guardar Todo\"\\n4. Vuelve y pregÃºntame de nuevo ğŸ˜Š`;\n    }\n\n    // HAY DATOS - Hacer anÃ¡lisis completo\n    const totalCalories = allFoods.reduce((sum, food) => sum + (food.calories || 0), 0);\n    const totalProtein = allFoods.reduce((sum, food) => sum + (food.protein || 0), 0);\n    const totalCarbs = allFoods.reduce((sum, food) => sum + (food.carbs || 0), 0);\n    const totalFat = allFoods.reduce((sum, food) => sum + (food.fat || 0), 0);\n    let response = `ğŸ“Š **Tu alimentaciÃ³n de hoy:**\\n\\n`;\n\n    // Mostrar por comida\n    const comidas = [{\n      key: 'breakfast',\n      nombre: 'Desayuno',\n      icono: 'ğŸŒ…'\n    }, {\n      key: 'lunch',\n      nombre: 'Almuerzo',\n      icono: 'ğŸ½ï¸'\n    }, {\n      key: 'dinner',\n      nombre: 'Cena',\n      icono: 'ğŸŒ™'\n    }, {\n      key: 'snacks',\n      nombre: 'Meriendas',\n      icono: 'ğŸª'\n    }];\n    comidas.forEach(comida => {\n      const items = userFoodData.meals[comida.key] || [];\n      if (items.length > 0) {\n        response += `${comida.icono} **${comida.nombre}:**\\n`;\n        items.forEach(item => {\n          response += `  â€¢ ${item.name} (${item.calories} kcal)\\n`;\n        });\n        response += `\\n`;\n      }\n    });\n    response += `**ğŸ“ˆ Totales:**\\n`;\n    response += `â€¢ CalorÃ­as: ${totalCalories.toFixed(0)} kcal\\n`;\n    response += `â€¢ ProteÃ­nas: ${totalProtein.toFixed(1)}g\\n`;\n    response += `â€¢ Carbos: ${totalCarbs.toFixed(1)}g\\n`;\n    response += `â€¢ Grasas: ${totalFat.toFixed(1)}g\\n\\n`;\n\n    // EvaluaciÃ³n\n    if (userProfile && userProfile.calorieGoal) {\n      const diff = totalCalories - userProfile.calorieGoal;\n      response += `**ğŸ¯ EvaluaciÃ³n:**\\n`;\n      if (diff > 300) {\n        response += `âš ï¸ Te pasaste ${diff.toFixed(0)} kcal. No hagas de esto un hÃ¡bito.\\n`;\n      } else if (diff > 100) {\n        response += `â„¹ï¸ EstÃ¡s ${diff.toFixed(0)} kcal arriba. Modera maÃ±ana.\\n`;\n      } else if (diff < -300) {\n        response += `âš ï¸ Te faltan ${Math.abs(diff).toFixed(0)} kcal. Come mÃ¡s.\\n`;\n      } else {\n        response += `âœ… Â¡Perfecto! Dentro de tu objetivo.\\n`;\n      }\n      const targetProtein = userProfile.calorieGoal * 0.30 / 4;\n      if (totalProtein < targetProtein * 0.8) {\n        response += `ğŸ¥© Baja en proteÃ­na. Agrega pollo/pescado/huevos.\\n`;\n      }\n    }\n    return response;\n  }\n\n  // ===== 2. PREGUNTAS SOBRE PROTEÃNAS =====\n  if (input.includes('proteÃ­na') || input.includes('proteina')) {\n    console.log('âœ… Detectado: pregunta sobre proteÃ­nas');\n\n    // Buscar alimento especÃ­fico mencionado\n    const alimentos = ALIMENTOS_DB.filter(a => input.includes(a.nombre.toLowerCase()));\n    if (alimentos.length > 0) {\n      let resp = '';\n      alimentos.slice(0, 3).forEach(alimento => {\n        resp += `**${alimento.nombre}:**\\n`;\n        resp += `ğŸ¥© ProteÃ­nas: ${alimento.proteinas || 0}g\\n`;\n        resp += `ğŸ”¥ ${alimento.calorias} kcal\\n\\n`;\n      });\n      return resp;\n    }\n\n    // Lista general de altos en proteÃ­na\n    if (input.includes('mÃ¡s') || input.includes('mas') || input.includes('alta') || input.includes('mayor')) {\n      const topProtein = ALIMENTOS_DB.filter(a => a.proteinas && a.proteinas > 20).sort((a, b) => b.proteinas - a.proteinas).slice(0, 8);\n      let resp = `ğŸ¥© **Top alimentos en proteÃ­na:**\\n\\n`;\n      topProtein.forEach((a, i) => {\n        resp += `${i + 1}. ${a.nombre}: ${a.proteinas}g (${a.calorias} kcal)\\n`;\n      });\n      return resp;\n    }\n  }\n\n  // ===== 3. CALORÃAS DE ALIMENTOS =====\n  if (input.includes('calorÃ­as') || input.includes('calorias') || input.includes('kcal')) {\n    console.log('âœ… Detectado: pregunta sobre calorÃ­as');\n    const alimentos = ALIMENTOS_DB.filter(a => input.includes(a.nombre.toLowerCase()));\n    if (alimentos.length > 0) {\n      let resp = '';\n      alimentos.slice(0, 3).forEach(alimento => {\n        resp += `**${alimento.nombre}:**\\n`;\n        resp += `ğŸ”¥ ${alimento.calorias} kcal\\n`;\n        if (alimento.proteinas) resp += `ğŸ¥© ProteÃ­nas: ${alimento.proteinas}g\\n`;\n        if (alimento.carbohidratos) resp += `ğŸ Carbos: ${alimento.carbohidratos}g\\n`;\n        if (alimento.grasas) resp += `ğŸ¥‘ Grasas: ${alimento.grasas}g\\n`;\n        resp += `\\n`;\n      });\n      return resp;\n    }\n  }\n\n  // ===== 4. DÃ‰FICIT CALÃ“RICO =====\n  if (input.includes('dÃ©ficit') || input.includes('deficit') || input.includes('bajar') || input.includes('adelgazar') || input.includes('perder')) {\n    console.log('âœ… Detectado: pregunta sobre dÃ©ficit calÃ³rico');\n    return `ğŸ¯ **Para dÃ©ficit calÃ³rico:**\\n\\n**âœ… SÃ comer:**\\nâ€¢ Pollo, pescado, claras de huevo\\nâ€¢ Verduras (todas)\\nâ€¢ Bebidas Zero\\nâ€¢ Frutas (moderado)\\n\\n**âŒ EVITAR:**\\nâ€¢ Gaseosas normales (140 kcal vacÃ­as)\\nâ€¢ Frituras\\nâ€¢ Dulces y postres\\nâ€¢ Alcohol\\nâ€¢ Exceso de arroz\\n\\nğŸ’¡ Prioriza proteÃ­na + verduras.`;\n  }\n\n  // ===== 5. GANAR MÃšSCULO =====\n  if (input.includes('mÃºsculo') || input.includes('musculo') || input.includes('masa') || input.includes('volumen') || input.includes('crecer')) {\n    console.log('âœ… Detectado: pregunta sobre ganar mÃºsculo');\n    return `ğŸ’ª **Para ganar mÃºsculo:**\\n\\n**ProteÃ­na (1.6-2.2g/kg):**\\nâ€¢ Pollo: 35g\\nâ€¢ Huevos (2): 14g\\nâ€¢ Yogurt griego: 12g\\nâ€¢ Pescado: 28g\\n\\n**Carbos post-entreno:**\\nâ€¢ Arroz con pollo: 55g\\nâ€¢ Avena: 50g\\nâ€¢ PlÃ¡tano: 30g\\n\\n**Grasas:**\\nâ€¢ Palta, frutos secos\\n\\nğŸ’¡ Come cada 3-4h y duerme 7-8h.`;\n  }\n\n  // ===== 6. PREGUNTAS SIMPLES/COMPARACIONES =====\n  if (input.match(/^(cual|cuÃ¡l|que|quÃ©)\\s*(tomo|como|es mejor|elijo|escojo|prefiero|recomiendas)$/i)) {\n    console.log('âœ… Detectado: pregunta de comparaciÃ³n genÃ©rica');\n    return `ğŸ’¡ **Para responder mejor, sÃ© mÃ¡s especÃ­fico:**\\n\\nğŸ¥¤ **Bebidas:**\\nâ€¢ \"Â¿Coca Cola Zero o normal?\"\\nâ€¢ \"Â¿QuÃ© bebida tomar en dÃ©ficit?\"\\n\\nğŸ½ï¸ **Comidas:**\\nâ€¢ \"Â¿Arroz o quinoa?\"\\nâ€¢ \"Â¿QuÃ© comer post-entreno?\"\\n\\nğŸ¥© **ProteÃ­nas:**\\nâ€¢ \"Â¿Pollo o pescado?\"\\nâ€¢ \"Â¿QuÃ© tiene mÃ¡s proteÃ­na?\"\\n\\nÂ¿Sobre quÃ© quieres saber especÃ­ficamente?`;\n  }\n\n  // ===== 7. SALUDOS =====\n  if (input.match(/^(hola|hey|buenas|quÃ© tal|que tal|buenas tardes|buenos dÃ­as|buenos dias|holi|ola)$/)) {\n    console.log('âœ… Detectado: saludo');\n    return `Â¡Hola! Â¿QuÃ© tal? ğŸ‘‹\\n\\nSoy tu asesor fitness. Puedo ayudarte con todo lo relacionado a nutriciÃ³n:\\n\\nï¿½ **PregÃºntame cosas como:**\\nâ€¢ \"Â¿EstÃ¡ bien lo que comÃ­?\"\\nâ€¢ \"Â¿CuÃ¡ntas calorÃ­as tiene el pollo a la brasa?\"\\nâ€¢ \"Â¿QuÃ© comer para bajar de peso?\"\\nâ€¢ \"Â¿Es malo el arroz en la noche?\"\\nâ€¢ \"Â¿Coca Cola Zero o normal?\"\\n\\nÂ¿En quÃ© te ayudo hoy? ğŸ˜Š`;\n  }\n\n  // ===== 8. AGRADECIMIENTOS =====\n  if (input.match(/^(gracias|thanks|grax|ty|thank you|thx|muchas gracias)$/)) {\n    console.log('âœ… Detectado: agradecimiento');\n    return `Â¡De nada, bro/sis! ğŸ˜Š Para eso estoy. Si tienes mÃ¡s dudas, aquÃ­ estoy ğŸ’ª`;\n  }\n\n  // ===== 9. HIDRATACIÃ“N =====\n  if (input.includes('agua') || input.includes('hidrat') || input.includes('tomar') || input.includes('beber')) {\n    console.log('âœ… Detectado: pregunta sobre hidrataciÃ³n');\n    return `ğŸ’§ **HidrataciÃ³n Ã³ptima:**\\n\\n**Meta diaria:** 2.5-3 litros\\n\\n**CuÃ¡ndo beber:**\\nâ€¢ Al despertar: 500ml\\nâ€¢ Antes de entrenar: 300ml\\nâ€¢ Durante entreno: 150ml cada 15min\\nâ€¢ DespuÃ©s: 500ml\\nâ€¢ Con cada comida: 250ml\\n\\n**SeÃ±ales de deshidrataciÃ³n:**\\nâŒ Orina oscura\\nâŒ Sed excesiva\\nâŒ Fatiga\\nâŒ Dolor de cabeza\\n\\nâœ… Orina clara = bien hidratado`;\n  }\n\n  // ===== 10. SUPLEMENTOS =====\n  if (input.includes('suplemento') || input.includes('proteÃ­na en polvo') || input.includes('whey') || input.includes('creatina') || input.includes('pre-workout')) {\n    console.log('âœ… Detectado: pregunta sobre suplementos');\n    return `ğŸ’Š **Suplementos bÃ¡sicos:**\\n\\n**ESENCIALES:**\\nâœ… ProteÃ­na Whey (si no llegas a meta)\\nâ€¢ 25-30g post-entreno\\nâ€¢ O cuando no puedas comer\\n\\nâœ… Creatina monohidrato\\nâ€¢ 5g diarios (cualquier hora)\\nâ€¢ Mejora fuerza y recuperaciÃ³n\\n\\n**OPCIONALES:**\\nâšª Pre-workout (solo si entrenas muy temprano)\\nâšª Omega 3 (si no comes pescado)\\nâšª Vitamina D (si no tomas sol)\\n\\nâŒ **NO necesitas:** BCAA, glutamina, quemadores\\n\\nğŸ’¡ La comida real siempre es mejor.`;\n  }\n\n  // ===== 11. HORARIOS DE COMIDA =====\n  if (input.includes('cuÃ¡ndo comer') || input.includes('cuando comer') || input.includes('horario') || input.includes('hora') && (input.includes('comer') || input.includes('comida'))) {\n    console.log('âœ… Detectado: pregunta sobre horarios');\n    return `â° **Horarios de comida Ã³ptimos:**\\n\\n**Para dÃ©ficit calÃ³rico:**\\nğŸŒ… Desayuno: 8-9am (proteÃ­na + carbos)\\nğŸ½ï¸ Almuerzo: 1-2pm (comida grande)\\nğŸŒ™ Cena: 7-8pm (proteÃ­na + verduras)\\n\\n**Para ganar mÃºsculo:**\\nğŸŒ… Desayuno: 7-8am\\nğŸ Snack: 10-11am\\nğŸ½ï¸ Almuerzo: 1-2pm\\nğŸ¥¤ Pre-entreno: 1h antes\\nğŸ’ª Post-entreno: Dentro de 1h\\nğŸŒ™ Cena: 8-9pm\\nğŸ¥› Antes dormir: CaseÃ­na/yogurt\\n\\nğŸ’¡ Come cada 3-4 horas para mantener metabolismo activo.`;\n  }\n\n  // ===== 12. CHEAT MEAL =====\n  if (input.includes('cheat') || input.includes('trampa') || input.includes('romper dieta') || input.includes('pizza') && input.includes('puedo')) {\n    console.log('âœ… Detectado: pregunta sobre cheat meal');\n    return `ğŸ• **Sobre las comidas trampa:**\\n\\n**Â¿Puedo tener cheat meals?**\\nâœ… SÃ, 1 vez por semana\\n\\n**Reglas:**\\n1. Solo si cumpliste 6 dÃ­as perfecto\\n2. Una comida, NO todo el dÃ­a\\n3. DisfrÃºtala sin culpa\\n4. Vuelve a la dieta al dÃ­a siguiente\\n\\n**Mejor estrategia:**\\nâ€¢ Programa tu cheat meal (sÃ¡bado noche)\\nâ€¢ Come normal el resto del dÃ­a\\nâ€¢ Entrena duro ese dÃ­a\\nâ€¢ No te peses al dÃ­a siguiente (retenciÃ³n de agua)\\n\\nğŸ’¡ Un cheat meal a la semana NO arruina tu progreso.\\nâŒ 3-4 cheat meals SÃ lo arruinan.`;\n  }\n\n  // ===== 13. EJERCICIO CARDIO =====\n  if (input.includes('cardio') || input.includes('correr') || input.includes('caminar') || input.includes('aerÃ³bico') || input.includes('aerobico')) {\n    console.log('âœ… Detectado: pregunta sobre cardio');\n    return `ğŸƒ **Cardio para resultados:**\\n\\n**Para QUEMAR GRASA:**\\nâœ… LISS (Low Intensity):\\nâ€¢ Caminar rÃ¡pido: 45-60min\\nâ€¢ 3-4 veces/semana\\nâ€¢ En ayunas (opcional)\\n\\nâœ… HIIT (High Intensity):\\nâ€¢ Sprints: 20-30min\\nâ€¢ 2-3 veces/semana\\nâ€¢ Quema mÃ¡s calorÃ­as post-ejercicio\\n\\n**Para MANTENER MÃšSCULO:**\\nâš ï¸ NO excedas:\\nâ€¢ 3-4 sesiones/semana\\nâ€¢ 30-45min mÃ¡ximo\\nâ€¢ Prioriza pesas sobre cardio\\n\\nğŸ’¡ Demasiado cardio = pierdes mÃºsculo\\nğŸ’ª Pesas + dieta > solo cardio`;\n  }\n\n  // ===== 14. DESCANSO Y SUEÃ‘O =====\n  if (input.includes('descanso') || input.includes('dormir') || input.includes('sueÃ±o') || input.includes('recuperaciÃ³n') || input.includes('recuperacion')) {\n    console.log('âœ… Detectado: pregunta sobre descanso');\n    return `ğŸ˜´ **Descanso y recuperaciÃ³n:**\\n\\n**SUEÃ‘O (crÃ­tico):**\\nâœ… 7-9 horas obligatorias\\nâ€¢ Antes de las 11pm\\nâ€¢ Cuarto oscuro y fresco\\nâ€¢ Sin pantallas 1h antes\\n\\n**DÃAS DE DESCANSO:**\\nâ€¢ MÃ­nimo 1-2 dÃ­as/semana\\nâ€¢ Caminar ligero estÃ¡ bien\\nâ€¢ Estiramientos/yoga ayudan\\n\\n**POR QUÃ‰ IMPORTA:**\\nğŸ’ª El mÃºsculo crece en el descanso, no en el gym\\nğŸ§  Mejora enfoque y energÃ­a\\nâš¡ Previene lesiones\\nğŸ”¥ Optimiza quema de grasa\\n\\nâŒ Menos de 6h = pierdes mÃºsculo y quemas menos grasa`;\n  }\n\n  // ===== 14. ALCOHOL =====\n  if (input.includes('alcohol') || input.includes('cerveza') || input.includes('licor') || input.includes('tomar') && (input.includes('fiesta') || input.includes('drinks'))) {\n    console.log('âœ… Detectado: pregunta sobre alcohol');\n    return `ğŸº **Alcohol y fitness:**\\n\\n**LA VERDAD DURA:**\\nâŒ Alcohol = veneno para tus objetivos\\nâ€¢ Bloquea sÃ­ntesis de proteÃ­na (mÃºsculo)\\nâ€¢ Aumenta cortisol (estrÃ©s/grasa)\\nâ€¢ Deshidrata severamente\\nâ€¢ CalorÃ­as vacÃ­as (7 kcal/gramo)\\n\\n**SI VAS A TOMAR:**\\nâš ï¸ LimÃ­tate a 1-2 veces/mes\\n\\n**Mejor opciÃ³n:**\\nâ€¢ Vodka/whisky + agua mineral\\nâ€¢ Ron + Coca Zero\\n\\n**PEOR opciÃ³n:**\\nâŒ Cerveza (carbos + alcohol)\\nâŒ CÃ³cteles dulces (azÃºcar + alcohol)\\nâŒ Shots (mucho alcohol rÃ¡pido)\\n\\nğŸ’¡ Una noche de copas = 3 dÃ­as de progreso perdido`;\n  }\n\n  // ===== 15. BEBIDAS Y GASEOSAS =====\n  if (input.includes('inka') || input.includes('coca cola') || input.includes('gaseosa') || input.includes('bebida') || input.includes('refresco') || input.includes('sprite') || input.includes('fanta') || input.match(/^(cual|cuÃ¡l)\\s*(tomo|bebo|es mejor)$/i)) {\n    console.log('âœ… Detectado: pregunta sobre bebidas/gaseosas');\n    if (input.includes('zero') || input.includes('cero') || input.includes('light') || input.includes('diet')) {\n      return `âœ… **Bebidas Zero/Light:**\\n\\n**EXCELENTES para dÃ©ficit:**\\nâ€¢ Coca Cola Zero: 0 kcal âœ…\\nâ€¢ Inka Cola Zero: 0 kcal âœ…\\nâ€¢ Sprite Zero: 0 kcal âœ…\\n\\nğŸ’¡ **Son SEGURAS:**\\nâ€¢ No rompen el dÃ©ficit\\nâ€¢ No afectan insulina\\nâ€¢ Ayudan con antojos de dulce\\n\\nâš ï¸ Pero: el agua sigue siendo mejor\\n\\nğŸ’ª Ãšsalas sin culpa en dÃ©ficit.`;\n    }\n\n    // Si pregunta \"cual tomo\" o similar\n    if (input.match(/^(cual|cuÃ¡l)\\s*(tomo|bebo|es mejor)$/i)) {\n      return `ğŸ¥¤ **Mi recomendaciÃ³n de bebidas:**\\n\\n**1ï¸âƒ£ MEJOR OPCIÃ“N:**\\nğŸ’§ Agua natural (2-3 litros/dÃ­a)\\n\\n**2ï¸âƒ£ BUENAS OPCIONES:**\\nâœ… Coca Cola Zero: 0 kcal\\nâœ… Inka Cola Zero: 0 kcal  \\nâœ… Sprite Zero: 0 kcal\\nâœ… CafÃ© negro: 0 kcal\\nâœ… TÃ© verde/negro: 0 kcal\\n\\n**3ï¸âƒ£ EVITAR:**\\nâŒ Coca Cola normal: 210 kcal\\nâŒ Inka Cola normal: 230 kcal\\nâŒ Jugos procesados: 150-200 kcal\\nâŒ NÃ©ctares: 180 kcal\\n\\nğŸ’¡ **Para dÃ©ficit calÃ³rico:** Solo agua y bebidas Zero.\\nğŸ’ª **Para ganar mÃºsculo:** Puedes tomar 1 gaseosa normal post-entreno (carbos rÃ¡pidos).`;\n    }\n    return `âŒ **Bebidas azucaradas:**\\n\\n**Coca Cola normal (500ml):**\\nâ€¢ 210 calorÃ­as\\nâ€¢ 55g azÃºcar\\nâ€¢ âŒ CERO nutrientes\\n\\n**Inka Cola normal (500ml):**\\nâ€¢ 230 calorÃ­as  \\nâ€¢ 58g azÃºcar\\nâ€¢ âŒ CERO nutrientes\\n\\n**ALTERNATIVAS:**\\nâœ… Coca Cola Zero: 0 kcal\\nâœ… Inka Cola Zero: 0 kcal\\nâœ… Agua con limÃ³n\\nâœ… TÃ© helado sin azÃºcar\\n\\nğŸ’¡ Una gaseosa normal = 30 minutos de cardio desperdiciados.\\n\\n**Para dÃ©ficit calÃ³rico:** SOLO bebidas Zero.`;\n  }\n\n  // ===== 16. COMIDA PERUANA ESPECÃFICA =====\n  if (input.includes('ceviche') || input.includes('lomo saltado') || input.includes('ajÃ­ de gallina') || input.includes('aji de gallina') || input.includes('pollo a la brasa') || input.includes('anticucho')) {\n    console.log('âœ… Detectado: pregunta sobre comida peruana');\n    let peruFood = '';\n    if (input.includes('ceviche')) {\n      peruFood = `ğŸŸ **Ceviche:**\\nâœ… EXCELENTE para dÃ©ficit\\nâ€¢ ~250 kcal/porciÃ³n\\nâ€¢ 35g proteÃ­na\\nâ€¢ Bajo en grasa\\n\\nğŸ’¡ Evita el camote/choclo si estÃ¡s en dÃ©ficit`;\n    } else if (input.includes('lomo saltado')) {\n      peruFood = `ğŸ– **Lomo Saltado:**\\nâš ï¸ MODERADO\\nâ€¢ ~450-550 kcal/porciÃ³n\\nâ€¢ 30g proteÃ­na\\nâ€¢ Alto en aceite\\n\\nğŸ’¡ Pide menos papas, mÃ¡s carne`;\n    } else if (input.includes('ajÃ­') || input.includes('aji')) {\n      peruFood = `ğŸ— **AjÃ­ de Gallina:**\\nâš ï¸ ALTO EN CALORÃAS\\nâ€¢ ~600 kcal/porciÃ³n\\nâ€¢ Mucha crema y aceite\\n\\nğŸ’¡ Solo para cheat meal o bulking`;\n    } else if (input.includes('pollo a la brasa')) {\n      peruFood = `ğŸ— **Pollo a la Brasa:**\\nâœ… BUENO (sin piel)\\nâ€¢ 1/4 pollo sin piel: ~300 kcal\\nâ€¢ 40g proteÃ­na\\n\\nâŒ Evita: papas fritas, cremas\\nâœ… Pide: ensalada, sin piel`;\n    } else if (input.includes('anticucho')) {\n      peruFood = `ä¸² **Anticuchos:**\\nâœ… EXCELENTE\\nâ€¢ 3 anticuchos: ~250 kcal\\nâ€¢ 28g proteÃ­na\\nâ€¢ Bajo en grasa\\n\\nğŸ’¡ Perfecto para post-entreno`;\n    }\n    return peruFood;\n  }\n\n  // ===== 17. AYUNO INTERMITENTE =====\n  if (input.includes('ayuno') || input.includes('intermitente') || input.includes('16/8') || input.includes('no desayuno')) {\n    console.log('âœ… Detectado: pregunta sobre ayuno');\n    return `â±ï¸ **Ayuno Intermitente:**\\n\\n**Â¿Funciona?**\\nâœ… SÃ, si te ayuda a comer menos calorÃ­as\\nâŒ NO es mÃ¡gico\\n\\n**Protocolo 16/8 (mÃ¡s comÃºn):**\\nâ€¢ Ayuno: 8pm - 12pm (16 horas)\\nâ€¢ Ventana: 12pm - 8pm (8 horas)\\n\\n**VENTAJAS:**\\nâ€¢ MÃ¡s fÃ¡cil estar en dÃ©ficit\\nâ€¢ Menos comidas que preparar\\nâ€¢ Claridad mental en ayunas\\n\\n**DESVENTAJAS:**\\nâŒ DifÃ­cil para ganar mÃºsculo\\nâŒ Posible pÃ©rdida de mÃºsculo\\nâŒ Poca energÃ­a para entrenar\\n\\nğŸ’¡ **MI CONSEJO:**\\nSolo Ãºsalo si te facilita el dÃ©ficit calÃ³rico.\\nPara ganar mÃºsculo â†’ come 4-5 veces/dÃ­a.`;\n  }\n\n  // ===== 18. MESETA/PLATEAU =====\n  if (input.includes('meseta') || input.includes('estancado') || input.includes('no bajo') || input.includes('no pierdo') || input.includes('plateau')) {\n    console.log('âœ… Detectado: pregunta sobre meseta');\n    return `ğŸ“Š **Rompiendo la meseta:**\\n\\n**Â¿Por quÃ© pasa?**\\nTu cuerpo se adaptÃ³. Necesitas cambios.\\n\\n**SOLUCIONES:**\\n\\n1ï¸âƒ£ **Recalcula tus calorÃ­as:**\\n   â€¢ Pesaste menos â†’ necesitas menos calorÃ­as\\n   â€¢ Reduce 100-200 kcal mÃ¡s\\n\\n2ï¸âƒ£ **Aumenta actividad:**\\n   â€¢ +10min cardio\\n   â€¢ +5,000 pasos diarios\\n\\n3ï¸âƒ£ **Refeed estratÃ©gico:**\\n   â€¢ 1 dÃ­a come a mantenimiento\\n   â€¢ Resetea hormonas (leptina)\\n\\n4ï¸âƒ£ **Revisa TODO lo que comes:**\\n   â€¢ Aceites, aderezos, \"probaditas\"\\n   â€¢ Pesa tu comida 1 semana\\n\\n5ï¸âƒ£ **Duerme mÃ¡s:**\\n   â€¢ Menos de 7h = mÃ¡s cortisol = guardas grasa\\n\\nğŸ’ª Dale 2 semanas con los cambios antes de rendirte.`;\n  }\n\n  // ===== 19. ANTOJOS =====\n  if (input.includes('antojo') || input.includes('ansiedad') || input.includes('hambre') && input.includes('todo el tiempo')) {\n    console.log('âœ… Detectado: pregunta sobre antojos');\n    return `ğŸ« **Controlando antojos:**\\n\\n**ESTRATEGIAS QUE FUNCIONAN:**\\n\\n1ï¸âƒ£ **Come mÃ¡s proteÃ­na:**\\n   â€¢ 30g en cada comida\\n   â€¢ Te mantiene lleno por horas\\n\\n2ï¸âƒ£ **Toma mÃ¡s agua:**\\n   â€¢ 500ml antes de cada comida\\n   â€¢ A veces es sed, no hambre\\n\\n3ï¸âƒ£ **Duerme suficiente:**\\n   â€¢ Menos de 7h = +25% antojos\\n   â€¢ Sube grelina (hormona del hambre)\\n\\n4ï¸âƒ£ **Alimentos voluminosos:**\\n   â€¢ Verduras (comes mucho, pocas calorÃ­as)\\n   â€¢ Palomitas sin mantequilla\\n   â€¢ Gelatina light\\n\\n5ï¸âƒ£ **Chicles sin azÃºcar:**\\n   â€¢ EngaÃ±a al cerebro\\n\\n6ï¸âƒ£ **Snacks de emergencia:**\\n   â€¢ Zanahoria + hummus\\n   â€¢ Pepino + tajÃ­n\\n   â€¢ Manzana + mantequilla de manÃ­ (1 cucharada)\\n\\nğŸ’¡ Si tienes antojo de algo especÃ­fico, cÃ³melo en pequeÃ±a cantidad.\\nEs mejor 2 cuadros de chocolate que comerte todo el refrigerador despuÃ©s.`;\n  }\n\n  // ===== 21. NO ENTENDIÃ“ - Usar API =====\n  console.log('âš ï¸ No categorizado, usando API Gemini...');\n  return null; // Esto harÃ¡ que el sistema use la API\n};\n\n// Usamos `react-markdown` con `remark-gfm` para renderizado seguro y completo de Markdown\n\n// Mensaje de bienvenida\nconst WELCOME_MESSAGE = `Â¡QuÃ© onda! ğŸ‘‹ Soy tu asesor fitness personal en SnorxFit.\n\nEstoy aquÃ­ para ayudarte con tu alimentaciÃ³n y nutriciÃ³n. Tengo info de +220 alimentos peruanos e internacionales.\n\nï¿½ **PregÃºntame lo que sea, por ejemplo:**\n\nğŸ”¥ **Sobre tu alimentaciÃ³n:**\nâ€¢ \"Â¿EstÃ¡ bien lo que comÃ­ hoy?\"\nâ€¢ \"Â¿CÃ³mo voy con mis calorÃ­as?\"\n\nğŸ¥© **Info de alimentos:**\nâ€¢ \"Â¿CuÃ¡ntas calorÃ­as tiene el lomo saltado?\"\nâ€¢ \"Â¿QuÃ© tiene mÃ¡s proteÃ­na, pollo o pescado?\"\n\nğŸ’ª **Para tus objetivos:**\nâ€¢ \"Â¿QuÃ© comer para bajar de peso?\"\nâ€¢ \"Â¿CÃ³mo ganar mÃºsculo sin engordar?\"\n\nğŸ¥¤ **Comparaciones:**\nâ€¢ \"Â¿Coca Cola o Coca Zero?\"\nâ€¢ \"Â¿Es malo comer arroz en la noche?\"\n\nHabla normal, sin miedo. Estoy para ayudarte ğŸ˜Š`;\nconst Chatbot = ({\n  onBack,\n  userProfile: userProfileProp\n}) => {\n  _s();\n  const {\n    user\n  } = useAuth();\n  const [conversations, setConversations] = useState([]);\n  const [activeConversationId, setActiveConversationId] = useState(null);\n  const [messages, setMessages] = useState([{\n    id: 1,\n    text: WELCOME_MESSAGE,\n    sender: 'bot',\n    timestamp: new Date().toISOString()\n  }]);\n  const [input, setInput] = useState('');\n  const [isLoading, setIsLoading] = useState(false);\n  const [userFoodData, setUserFoodData] = useState(null);\n  const [historyLoaded, setHistoryLoaded] = useState(false);\n  const [showSidebar, setShowSidebar] = useState(typeof window !== 'undefined' ? window.innerWidth >= 768 : true);\n  const [charCount, setCharCount] = useState(0);\n  const [userPreferences, setUserPreferences] = useState(null);\n  // userProfile viene del prop, no del state local\n  const MAX_CHARS = 500;\n  const messagesEndRef = useRef(null);\n\n  // Cargar historial de chat desde Firebase\n  useEffect(() => {\n    const loadChatHistory = async () => {\n      if (!user || historyLoaded) return;\n      try {\n        const chatHistoryRef = collection(db, 'users', user.uid, 'chatHistory');\n        const q = query(chatHistoryRef, orderBy('timestamp', 'desc'), limit(50));\n        const querySnapshot = await getDocs(q);\n        if (!querySnapshot.empty) {\n          const historyMessages = [];\n          querySnapshot.forEach(doc => {\n            const data = doc.data();\n            historyMessages.push({\n              id: doc.id,\n              text: data.message,\n              sender: data.sender,\n              timestamp: data.timestamp,\n              isLocal: data.isLocal || false\n            });\n          });\n\n          // Invertir para orden cronolÃ³gico\n          historyMessages.reverse();\n\n          // Agregar mensaje de bienvenida + historial\n          setMessages([{\n            id: 'welcome',\n            text: WELCOME_MESSAGE,\n            sender: 'bot',\n            timestamp: new Date().toISOString()\n          }, ...historyMessages]);\n          console.log('ğŸ’¬ Historial de chat cargado:', historyMessages.length, 'mensajes');\n        }\n        setHistoryLoaded(true);\n      } catch (error) {\n        console.error('âŒ Error cargando historial:', error);\n        setHistoryLoaded(true);\n      }\n    };\n    loadChatHistory();\n  }, [user, historyLoaded]);\n\n  // Cargar datos de alimentaciÃ³n del usuario\n  useEffect(() => {\n    const loadUserFoodData = async () => {\n      if (!user) return;\n      try {\n        const today = getLocalDateString();\n        const docRef = doc(db, 'users', user.uid, 'foodLogs', today);\n        const docSnap = await getDoc(docRef);\n        let dataFromFirestore = null;\n        if (docSnap.exists()) {\n          dataFromFirestore = docSnap.data();\n          console.log('ğŸ“Š Datos de alimentaciÃ³n cargados desde Firestore:', dataFromFirestore);\n        } else {\n          console.log('ï¿½ No hay datos de alimentaciÃ³n en Firestore para hoy');\n        }\n\n        // Leer cache local y fusionar para que el chatbot tenga siempre la info mÃ¡s completa\n        let cached = null;\n        try {\n          cached = JSON.parse(localStorage.getItem(`foodLog_${today}`) || 'null');\n        } catch (e) {\n          cached = null;\n        }\n        if (cached && cached.meals) {\n          // Si no hay datos en Firestore, usar cache directo\n          if (!dataFromFirestore) {\n            setUserFoodData(cached);\n            console.log('ï¿½ Usando cache local para userFoodData:', cached);\n          } else {\n            // Fusionar arrays por tipo de comida evitando duplicados por id o name\n            const merged = {\n              meals: {},\n              water: cached.water || dataFromFirestore.water || 0\n            };\n            const mealTypes = ['breakfast', 'lunch', 'dinner', 'snacks'];\n            mealTypes.forEach(mt => {\n              const fromFs = dataFromFirestore.meals && dataFromFirestore.meals[mt] || [];\n              const fromCache = cached.meals && cached.meals[mt] || [];\n              const mapIds = new Map();\n              fromFs.forEach(item => {\n                const key = item.id || item.name && item.name.toString().toLowerCase();\n                if (key) mapIds.set(key, item);\n              });\n              fromCache.forEach(item => {\n                const key = item.id || item.name && item.name.toString().toLowerCase();\n                if (key && !mapIds.has(key)) {\n                  mapIds.set(key, item);\n                }\n              });\n              merged.meals[mt] = Array.from(mapIds.values());\n            });\n            setUserFoodData(merged);\n            console.log('ğŸ”€ userFoodData fusionado (Firestore + cache):', merged);\n          }\n        } else if (dataFromFirestore) {\n          setUserFoodData(dataFromFirestore);\n          console.log('ğŸ“Š userFoodData establecido desde Firestore');\n        } else {\n          setUserFoodData(null);\n          console.log('ğŸ“‹ No hay datos de alimentaciÃ³n disponibles (ni Firestore ni cache)');\n        }\n      } catch (error) {\n        console.error('âŒ Error cargando datos:', error);\n      }\n    };\n    loadUserFoodData();\n  }, [user]);\n  const scrollToBottom = () => {\n    var _messagesEndRef$curre;\n    (_messagesEndRef$curre = messagesEndRef.current) === null || _messagesEndRef$curre === void 0 ? void 0 : _messagesEndRef$curre.scrollIntoView({\n      behavior: 'smooth'\n    });\n  };\n  useEffect(() => {\n    scrollToBottom();\n  }, [messages]);\n\n  // Cargar conversaciones del usuario\n  useEffect(() => {\n    const loadConversations = async () => {\n      if (!user) return;\n      try {\n        const conversationsRef = collection(db, 'users', user.uid, 'conversations');\n        const q = query(conversationsRef, orderBy('lastUpdated', 'desc'), limit(20));\n        const querySnapshot = await getDocs(q);\n        const convos = [];\n        querySnapshot.forEach(doc => {\n          convos.push({\n            id: doc.id,\n            ...doc.data()\n          });\n        });\n        setConversations(convos);\n\n        // Si no hay conversaciÃ³n activa, crear una nueva\n        if (!activeConversationId && convos.length > 0) {\n          setActiveConversationId(convos[0].id);\n          loadConversationMessages(convos[0].id);\n        } else if (convos.length === 0) {\n          createNewConversation();\n        }\n      } catch (error) {\n        console.error('âŒ Error cargando conversaciones:', error);\n      }\n    };\n    loadConversations();\n  }, [user]);\n\n  // Cargar preferencias y perfil del usuario\n  useEffect(() => {\n    const loadUserData = async () => {\n      if (!user) return;\n      try {\n        // El perfil viene como prop desde App.js, solo cargamos preferencias\n        console.log('ğŸ‘¤ Usando perfil del prop:', userProfileProp);\n        if (userProfileProp) {\n          console.log('  âœ… Nombre:', userProfileProp.name);\n          console.log('  âœ… Objetivo:', userProfileProp.goal);\n          console.log('  âœ… Edad:', userProfileProp.age);\n          console.log('  âœ… Peso:', userProfileProp.weight);\n          console.log('  âœ… Altura:', userProfileProp.height);\n          console.log('  âœ… Actividad:', userProfileProp.activityLevel);\n          console.log('  âœ… CalorÃ­as diarias:', userProfileProp.dailyCalories);\n          console.log('  âœ… Alimentos favoritos:', userProfileProp.selectedFoods ? Object.keys(userProfileProp.selectedFoods).length : 0);\n        } else {\n          console.warn('âš ï¸ No se recibiÃ³ userProfile como prop');\n        }\n\n        // Cargar o generar preferencias del usuario\n        const prefs = await getUserPreferences(user.uid);\n        setUserPreferences(prefs);\n        console.log('ğŸ¯ Preferencias del usuario cargadas:', prefs);\n\n        // Si no hay preferencias, analizar despuÃ©s de 3 segundos\n        if (!prefs || !prefs.favoriteFoods || prefs.favoriteFoods.length === 0) {\n          console.log('â³ Generando anÃ¡lisis de preferencias...');\n          setTimeout(async () => {\n            const newPrefs = await analyzeUserPreferences(user.uid, 30);\n            setUserPreferences(newPrefs);\n            console.log('âœ… Preferencias generadas:', newPrefs);\n          }, 3000);\n        }\n      } catch (error) {\n        console.error('âŒ Error cargando datos de usuario:', error);\n      }\n    };\n    loadUserData();\n  }, [user]);\n\n  // Crear nueva conversaciÃ³n\n  const createNewConversation = async () => {\n    if (!user) return;\n    try {\n      const conversationsRef = collection(db, 'users', user.uid, 'conversations');\n      const newConvo = await addDoc(conversationsRef, {\n        title: 'Nueva conversaciÃ³n',\n        createdAt: serverTimestamp(),\n        lastUpdated: serverTimestamp(),\n        messageCount: 0\n      });\n      setActiveConversationId(newConvo.id);\n      setMessages([{\n        id: 'welcome',\n        text: WELCOME_MESSAGE,\n        sender: 'bot',\n        timestamp: new Date().toISOString()\n      }]);\n\n      // Recargar lista\n      const q = query(conversationsRef, orderBy('lastUpdated', 'desc'), limit(20));\n      const querySnapshot = await getDocs(q);\n      const convos = [];\n      querySnapshot.forEach(doc => {\n        convos.push({\n          id: doc.id,\n          ...doc.data()\n        });\n      });\n      setConversations(convos);\n      console.log('âœ… Nueva conversaciÃ³n creada');\n    } catch (error) {\n      console.error('âŒ Error creando conversaciÃ³n:', error);\n    }\n  };\n\n  // Cargar mensajes de una conversaciÃ³n\n  const loadConversationMessages = async conversationId => {\n    if (!user) return;\n    try {\n      const messagesRef = collection(db, 'users', user.uid, 'conversations', conversationId, 'messages');\n      const q = query(messagesRef, orderBy('timestamp', 'asc'), limit(100));\n      const querySnapshot = await getDocs(q);\n      const msgs = [{\n        id: 'welcome',\n        text: WELCOME_MESSAGE,\n        sender: 'bot',\n        timestamp: new Date().toISOString()\n      }];\n      querySnapshot.forEach(doc => {\n        const data = doc.data();\n        msgs.push({\n          id: doc.id,\n          text: data.message,\n          sender: data.sender,\n          timestamp: data.timestamp,\n          isLocal: data.isLocal || false\n        });\n      });\n      setMessages(msgs);\n      setActiveConversationId(conversationId);\n    } catch (error) {\n      console.error('âŒ Error cargando mensajes:', error);\n    }\n  };\n\n  // Eliminar conversaciÃ³n\n  const deleteConversation = async conversationId => {\n    if (!window.confirm('Â¿Eliminar esta conversaciÃ³n?')) return;\n    try {\n      // Eliminar mensajes\n      const messagesRef = collection(db, 'users', user.uid, 'conversations', conversationId, 'messages');\n      const messagesSnapshot = await getDocs(messagesRef);\n      await Promise.all(messagesSnapshot.docs.map(doc => deleteDoc(doc.ref)));\n\n      // Eliminar conversaciÃ³n\n      await deleteDoc(doc(db, 'users', user.uid, 'conversations', conversationId));\n\n      // Actualizar UI\n      const updatedConvos = conversations.filter(c => c.id !== conversationId);\n      setConversations(updatedConvos);\n      if (activeConversationId === conversationId) {\n        if (updatedConvos.length > 0) {\n          loadConversationMessages(updatedConvos[0].id);\n        } else {\n          createNewConversation();\n        }\n      }\n      console.log('âœ… ConversaciÃ³n eliminada');\n    } catch (error) {\n      console.error('âŒ Error eliminando:', error);\n    }\n  };\n\n  // FunciÃ³n para refrescar preferencias del usuario\n  const refreshUserPreferences = async () => {\n    if (!user) return;\n    try {\n      console.log('ğŸ”„ Actualizando preferencias del usuario...');\n      const newPrefs = await analyzeUserPreferences(user.uid, 30);\n      setUserPreferences(newPrefs);\n      console.log('âœ… Preferencias actualizadas:', newPrefs);\n    } catch (error) {\n      console.error('âŒ Error actualizando preferencias:', error);\n    }\n  };\n\n  // FunciÃ³n para guardar mensajes en Firebase\n  const saveChatMessage = async (message, sender, isLocal = false) => {\n    if (!user || !activeConversationId) return;\n    try {\n      // Guardar mensaje\n      const messagesRef = collection(db, 'users', user.uid, 'conversations', activeConversationId, 'messages');\n      await addDoc(messagesRef, {\n        message,\n        sender,\n        isLocal,\n        timestamp: serverTimestamp()\n      });\n\n      // Actualizar conversaciÃ³n\n      const convoRef = doc(db, 'users', user.uid, 'conversations', activeConversationId);\n      const convoSnap = await getDoc(convoRef);\n      const currentData = convoSnap.data();\n\n      // TÃ­tulo automÃ¡tico del primer mensaje del usuario\n      let title = currentData.title;\n      if (title === 'Nueva conversaciÃ³n' && sender === 'user') {\n        title = message.substring(0, 40) + (message.length > 40 ? '...' : '');\n      }\n      await updateDoc(convoRef, {\n        lastUpdated: serverTimestamp(),\n        messageCount: (currentData.messageCount || 0) + 1,\n        title\n      });\n      console.log('ğŸ’¾ Mensaje guardado en conversaciÃ³n');\n    } catch (error) {\n      console.error('âŒ Error guardando mensaje:', error);\n    }\n  };\n  const handleSendMessage = async () => {\n    if (!input.trim()) return;\n    const userMessage = {\n      id: messages.length + 1,\n      text: input,\n      sender: 'user',\n      timestamp: new Date().toISOString()\n    };\n    setMessages(prev => [...prev, userMessage]);\n    const userInput = input;\n    setInput('');\n    setCharCount(0); // Resetear contador\n\n    // Guardar mensaje del usuario\n    await saveChatMessage(userInput, 'user');\n\n    // ğŸ PASO 1: Intentar buscar en GALERÃA LOCAL de alimentos\n    console.log('ğŸ” Buscando en base de datos local de alimentos...');\n    const startTime1 = Date.now();\n    const foodLocalResponse = getFoodNutritionFromLocal(userInput);\n    const latency1 = Date.now() - startTime1;\n    if (foodLocalResponse) {\n      console.log('âœ… Â¡Alimento encontrado en base de datos local!');\n      await logChatMetric('local_food', latency1, true, user === null || user === void 0 ? void 0 : user.uid);\n      const botMessage = {\n        id: messages.length + 2,\n        text: foodLocalResponse,\n        sender: 'bot',\n        isLocal: true,\n        timestamp: new Date().toISOString()\n      };\n      setMessages(prev => [...prev, botMessage]);\n\n      // Guardar respuesta del bot\n      await saveChatMessage(foodLocalResponse, 'bot', true);\n      return; // No usar API si hay respuesta local\n    }\n\n    // ğŸš€ PASO 2: Intentar respuestas predefinidas locales (INSTANTÃNEA)\n    console.log('ğŸ”„ Intentando respuestas predefinidas locales...');\n    const startTime2 = Date.now();\n    const localResponse = getLocalResponse(userInput, userFoodData, userProfileProp);\n    const latency2 = Date.now() - startTime2;\n    if (localResponse) {\n      console.log('âœ… Respuesta local predefinida encontrada!');\n      await logChatMetric('local_predefined', latency2, true, user === null || user === void 0 ? void 0 : user.uid);\n      const botMessage = {\n        id: messages.length + 2,\n        text: localResponse,\n        sender: 'bot',\n        isLocal: true,\n        timestamp: new Date().toISOString()\n      };\n      setMessages(prev => [...prev, botMessage]);\n\n      // Guardar respuesta del bot\n      await saveChatMessage(localResponse, 'bot', true);\n      return; // No usar API si hay respuesta local\n    }\n\n    // ğŸ“¡ PASO 3: Solo si no hay respuesta local, usar API de Gemini\n    console.log('ğŸ“¡ No hay respuesta local, consultando Gemini API...');\n    setIsLoading(true);\n    try {\n      // Crear contexto con los datos del usuario\n      let context = '';\n      if (userFoodData && userFoodData.meals) {\n        const allFoods = Object.values(userFoodData.meals).flat();\n        if (allFoods.length > 0) {\n          context += '\\n\\nRegistro de alimentaciÃ³n de hoy del usuario:\\n';\n          Object.entries(userFoodData.meals).forEach(([mealType, foods]) => {\n            if (foods.length > 0) {\n              context += `${mealType}: ${foods.map(f => f.name).join(', ')}\\n`;\n            }\n          });\n        }\n      }\n      if (userProfileProp && userProfileProp.calorieGoal) {\n        context += `\\nObjetivo calÃ³rico del usuario: ${userProfileProp.calorieGoal} kcal`;\n      }\n\n      // ğŸ¯ Agregar contexto personalizado basado en el perfil del usuario\n      // SIEMPRE generamos contexto si hay userProfile (preferences es opcional)\n      if (userProfileProp) {\n        console.log('ğŸ¯ Generando contexto personalizado...');\n        console.log('ğŸ“‹ Perfil del usuario:', {\n          nombre: userProfileProp.name,\n          objetivo: userProfileProp.goal,\n          peso: userProfileProp.weight,\n          altura: userProfileProp.height,\n          edad: userProfileProp.age,\n          actividad: userProfileProp.activityLevel,\n          calorias: userProfileProp.dailyCalories,\n          alimentosFavoritos: userProfileProp.selectedFoods ? Object.keys(userProfileProp.selectedFoods).length : 0\n        });\n\n        // Generar contexto incluso si userPreferences es null\n        const personalizedContext = generatePersonalizedContext(userProfileProp, userPreferences, userFoodData);\n        context += '\\n\\n' + personalizedContext;\n        console.log('âœ¨ Contexto personalizado agregado (primeros 400 caracteres):');\n        console.log(personalizedContext.substring(0, 400) + '...');\n        console.log('ğŸ“ Longitud total del contexto:', personalizedContext.length, 'caracteres');\n      } else {\n        console.warn('âš ï¸ No se pudo generar contexto personalizado:');\n        console.warn('  - userProfile existe?', !!userProfileProp);\n        console.warn('  - userPreferences existe?', !!userPreferences);\n      }\n      console.log('ğŸ¤– Llamando a Gemini API con contexto personalizado...');\n      console.log('ğŸ“¤ Prompt completo enviado a Gemini (primeros 300 caracteres):');\n      console.log((userInput + context).substring(0, 300) + '...');\n      const startTime3 = Date.now();\n      const response = await chatWithGemini(userInput + context);\n      const latency3 = Date.now() - startTime3;\n      console.log('âœ… Respuesta de API recibida exitosamente');\n      await logChatMetric('gemini_api', latency3, true, user === null || user === void 0 ? void 0 : user.uid);\n      const botMessage = {\n        id: messages.length + 2,\n        text: response,\n        sender: 'bot',\n        isLocal: false,\n        timestamp: new Date().toISOString()\n      };\n      setMessages(prev => [...prev, botMessage]);\n\n      // Guardar respuesta del bot de API\n      await saveChatMessage(response, 'bot', false);\n    } catch (error) {\n      console.error('âŒ Error completo de API:', error);\n      await logChatMetric('gemini_api', 0, false, user === null || user === void 0 ? void 0 : user.uid);\n\n      // Mensajes de error mÃ¡s especÃ­ficos\n      let errorText = 'âš ï¸ **Error con la IA:**\\n\\n';\n      if (error.message.includes('API Key invÃ¡lida')) {\n        errorText += 'ğŸ”‘ La API Key de Gemini no es vÃ¡lida.\\n\\n';\n      } else if (error.message.includes('LÃ­mite de peticiones')) {\n        errorText += 'â° Demasiadas peticiones. Espera un momento.\\n\\n';\n      } else if (error.message.includes('Network') || error.message.includes('Failed to fetch')) {\n        errorText += 'ğŸ“¡ Sin conexiÃ³n a internet.\\n\\n';\n      } else {\n        errorText += `Error: ${error.message}\\n\\n`;\n      }\n      errorText += `ğŸ’¡ **Mientras tanto, prueba preguntando:**\\n`;\n      errorText += `â€¢ \"Â¿EstÃ¡ bien lo que comÃ­?\"\\n`;\n      errorText += `â€¢ \"Â¿QuÃ© tiene mÃ¡s proteÃ­nas?\"\\n`;\n      errorText += `â€¢ \"Â¿CuÃ¡nta agua tomar?\"\\n`;\n      errorText += `â€¢ \"Â¿Puedo tomar cerveza?\"\\n`;\n      errorText += `â€¢ \"Dame opciones para dÃ©ficit calÃ³rico\"\\n\\n`;\n      errorText += `âœ… Estas preguntas funcionan sin IA.`;\n      const errorMessage = {\n        id: messages.length + 2,\n        text: errorText,\n        sender: 'bot'\n      };\n      setMessages(prev => [...prev, errorMessage]);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n  const handleKeyPress = e => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      handleSendMessage();\n    }\n  };\n  const handleInputChange = e => {\n    const value = e.target.value;\n    if (value.length <= MAX_CHARS) {\n      setInput(value);\n      setCharCount(value.length);\n    }\n  };\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-pink-900 text-white p-4\",\n    children: [/*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"max-w-7xl mx-auto mb-4 px-1\",\n      children: /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"flex items-center gap-4\",\n        children: [/*#__PURE__*/_jsxDEV(motion.button, {\n          whileHover: {\n            scale: 1.1\n          },\n          whileTap: {\n            scale: 0.9\n          },\n          onClick: onBack,\n          className: \"p-2 bg-white/10 backdrop-blur-sm rounded-lg hover:bg-white/20 transition-colors\",\n          children: /*#__PURE__*/_jsxDEV(ArrowLeft, {\n            size: 24\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1118,\n            columnNumber: 13\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1112,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(motion.button, {\n          whileHover: {\n            scale: 1.05\n          },\n          whileTap: {\n            scale: 0.95\n          },\n          onClick: () => setShowSidebar(prev => !prev),\n          className: \"p-2 bg-white/10 backdrop-blur-sm rounded-lg hover:bg-white/20 transition-colors md:hidden\",\n          \"aria-label\": \"Toggle historial\",\n          children: /*#__PURE__*/_jsxDEV(MessageCircle, {\n            size: 20\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1128,\n            columnNumber: 13\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1121,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"flex items-center gap-3\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"p-3 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl\",\n            children: /*#__PURE__*/_jsxDEV(MessageSquare, {\n              size: 24\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1132,\n              columnNumber: 15\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1131,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            children: [/*#__PURE__*/_jsxDEV(\"h1\", {\n              className: \"text-2xl font-bold\",\n              children: \"Asistente IA\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1135,\n              columnNumber: 15\n            }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n              className: \"text-sm opacity-75\",\n              children: \"Con historial de conversaciones\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1136,\n              columnNumber: 15\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1134,\n            columnNumber: 13\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 1130,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 1111,\n        columnNumber: 9\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 1110,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"max-w-7xl mx-auto flex flex-col md:flex-row gap-4 h-auto md:h-[calc(100vh-200px)]\",\n      children: [showSidebar && /*#__PURE__*/_jsxDEV(motion.div, {\n        initial: {\n          x: -100,\n          opacity: 0\n        },\n        animate: {\n          x: 0,\n          opacity: 1\n        },\n        className: \"w-full md:w-64 bg-black/30 backdrop-blur-sm rounded-2xl p-4 flex flex-col\",\n        children: [/*#__PURE__*/_jsxDEV(motion.button, {\n          whileHover: {\n            scale: 1.02\n          },\n          whileTap: {\n            scale: 0.98\n          },\n          onClick: createNewConversation,\n          className: \"w-full p-3 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg mb-4 flex items-center gap-2 justify-center font-medium\",\n          children: [/*#__PURE__*/_jsxDEV(Plus, {\n            size: 20\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1159,\n            columnNumber: 15\n          }, this), \"Nueva Conversaci\\xF3n\"]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 1153,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"flex-1 overflow-y-auto space-y-2\",\n          children: conversations.map(convo => /*#__PURE__*/_jsxDEV(\"div\", {\n            className: `p-3 rounded-lg cursor-pointer flex items-center justify-between group transition-all ${activeConversationId === convo.id ? 'bg-white/20' : 'bg-white/5 hover:bg-white/10'}`,\n            onClick: () => loadConversationMessages(convo.id),\n            children: [/*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"flex-1 min-w-0\",\n              children: [/*#__PURE__*/_jsxDEV(\"div\", {\n                className: \"flex items-center gap-2 mb-1\",\n                children: [/*#__PURE__*/_jsxDEV(MessageCircle, {\n                  size: 14,\n                  className: \"flex-shrink-0\"\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1177,\n                  columnNumber: 23\n                }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n                  className: \"text-sm font-medium truncate\",\n                  children: convo.title\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1178,\n                  columnNumber: 23\n                }, this)]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 1176,\n                columnNumber: 21\n              }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n                className: \"text-xs opacity-50\",\n                children: [convo.messageCount || 0, \" mensajes\"]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 1180,\n                columnNumber: 21\n              }, this)]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 1175,\n              columnNumber: 19\n            }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n              onClick: e => {\n                e.stopPropagation();\n                deleteConversation(convo.id);\n              },\n              className: \"opacity-0 group-hover:opacity-100 p-1 hover:bg-red-500/20 rounded transition-all\",\n              children: /*#__PURE__*/_jsxDEV(Trash2, {\n                size: 16,\n                className: \"text-red-400\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 1192,\n                columnNumber: 21\n              }, this)\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1185,\n              columnNumber: 19\n            }, this)]\n          }, convo.id, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1166,\n            columnNumber: 17\n          }, this))\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1164,\n          columnNumber: 13\n        }, this), userPreferences && userPreferences.favoriteFoods && userPreferences.favoriteFoods.length > 0 && /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"mt-4 pt-4 border-t border-white/10\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"text-xs font-semibold mb-2 opacity-75\",\n            children: \"\\uD83C\\uDFAF Tus Favoritos\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1201,\n            columnNumber: 17\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"space-y-1\",\n            children: userPreferences.favoriteFoods.slice(0, 3).map((food, index) => /*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"text-xs bg-white/5 rounded-lg p-2\",\n              children: /*#__PURE__*/_jsxDEV(\"div\", {\n                className: \"flex justify-between\",\n                children: [/*#__PURE__*/_jsxDEV(\"span\", {\n                  className: \"truncate\",\n                  children: food.name\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1206,\n                  columnNumber: 25\n                }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n                  className: \"text-purple-300 ml-2\",\n                  children: [food.percentage, \"%\"]\n                }, void 0, true, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1207,\n                  columnNumber: 25\n                }, this)]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 1205,\n                columnNumber: 23\n              }, this)\n            }, index, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1204,\n              columnNumber: 21\n            }, this))\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1202,\n            columnNumber: 17\n          }, this), userPreferences.dietType && /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"mt-2 text-xs bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-lg p-2\",\n            children: [/*#__PURE__*/_jsxDEV(\"span\", {\n              className: \"opacity-75\",\n              children: \"Dieta: \"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1214,\n              columnNumber: 21\n            }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n              className: \"font-medium\",\n              children: userPreferences.dietType\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1215,\n              columnNumber: 21\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1213,\n            columnNumber: 19\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 1200,\n          columnNumber: 15\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 1147,\n        columnNumber: 11\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"flex-1 bg-white/10 backdrop-blur-lg rounded-2xl shadow-2xl p-3 sm:p-4 flex flex-col\",\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"flex-1 overflow-y-auto mb-4 space-y-4 px-1\",\n          children: [/*#__PURE__*/_jsxDEV(AnimatePresence, {\n            children: messages.map(message => /*#__PURE__*/_jsxDEV(motion.div, {\n              initial: {\n                opacity: 0,\n                y: 20\n              },\n              animate: {\n                opacity: 1,\n                y: 0\n              },\n              exit: {\n                opacity: 0,\n                y: -20\n              },\n              className: `flex ${message.sender === 'user' ? 'justify-end' : 'justify-start'}`,\n              children: /*#__PURE__*/_jsxDEV(\"div\", {\n                className: `max-w-[90%] sm:max-w-[80%] p-3 sm:p-4 rounded-2xl ${message.sender === 'user' ? 'bg-gradient-to-r from-purple-500 to-pink-500' : 'bg-white/20 backdrop-blur-sm'}`,\n                children: [message.sender === 'bot' && /*#__PURE__*/_jsxDEV(\"div\", {\n                  className: \"flex items-center gap-2 mb-2 opacity-75\",\n                  children: [/*#__PURE__*/_jsxDEV(Sparkles, {\n                    size: 16\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 1245,\n                    columnNumber: 25\n                  }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n                    className: \"text-xs\",\n                    children: message.isLocal ? 'Respuesta Local' : 'IA (Gemini)'\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 1246,\n                    columnNumber: 25\n                  }, this)]\n                }, void 0, true, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1244,\n                  columnNumber: 23\n                }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n                  className: \"whitespace-pre-wrap prose prose-invert max-w-none\",\n                  children: /*#__PURE__*/_jsxDEV(ReactMarkdown, {\n                    remarkPlugins: [remarkGfm],\n                    children: message.text || ''\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 1252,\n                    columnNumber: 23\n                  }, this)\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1251,\n                  columnNumber: 21\n                }, this)]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 1236,\n                columnNumber: 19\n              }, this)\n            }, message.id, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1229,\n              columnNumber: 17\n            }, this))\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1227,\n            columnNumber: 13\n          }, this), isLoading && /*#__PURE__*/_jsxDEV(motion.div, {\n            initial: {\n              opacity: 0\n            },\n            animate: {\n              opacity: 1\n            },\n            className: \"flex justify-start\",\n            children: /*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"bg-white/20 backdrop-blur-sm p-4 rounded-2xl\",\n              children: /*#__PURE__*/_jsxDEV(\"div\", {\n                className: \"flex items-center gap-2\",\n                children: [/*#__PURE__*/_jsxDEV(\"div\", {\n                  className: \"flex gap-1\",\n                  children: [/*#__PURE__*/_jsxDEV(\"div\", {\n                    className: \"w-2 h-2 bg-white rounded-full animate-bounce\"\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 1268,\n                    columnNumber: 23\n                  }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n                    className: \"w-2 h-2 bg-white rounded-full animate-bounce\",\n                    style: {\n                      animationDelay: '0.1s'\n                    }\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 1269,\n                    columnNumber: 23\n                  }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n                    className: \"w-2 h-2 bg-white rounded-full animate-bounce\",\n                    style: {\n                      animationDelay: '0.2s'\n                    }\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 1270,\n                    columnNumber: 23\n                  }, this)]\n                }, void 0, true, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1267,\n                  columnNumber: 21\n                }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n                  className: \"text-sm opacity-75\",\n                  children: \"Pensando...\"\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1272,\n                  columnNumber: 21\n                }, this)]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 1266,\n                columnNumber: 19\n              }, this)\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1265,\n              columnNumber: 17\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1260,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            ref: messagesEndRef\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1278,\n            columnNumber: 13\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 1226,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"space-y-2\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"flex justify-between items-center px-2\",\n            children: [/*#__PURE__*/_jsxDEV(\"span\", {\n              className: `text-xs ${charCount > MAX_CHARS * 0.9 ? 'text-red-400' : 'opacity-50'}`,\n              children: [charCount, \"/\", MAX_CHARS, \" caracteres\"]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 1285,\n              columnNumber: 15\n            }, this), charCount > MAX_CHARS * 0.9 && /*#__PURE__*/_jsxDEV(\"span\", {\n              className: \"text-xs text-red-400\",\n              children: \"\\u26A0\\uFE0F Cerca del l\\xEDmite\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1289,\n              columnNumber: 17\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1284,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"flex flex-col sm:flex-row gap-2\",\n            children: [/*#__PURE__*/_jsxDEV(\"textarea\", {\n              value: input,\n              onChange: handleInputChange,\n              onKeyPress: handleKeyPress,\n              placeholder: \"Escribe tu mensaje... (m\\xE1ximo 500 caracteres)\",\n              className: \"flex-1 p-2 sm:p-4 bg-white/10 backdrop-blur-sm border border-white/20 rounded-xl text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none\",\n              rows: 2,\n              disabled: isLoading,\n              maxLength: MAX_CHARS\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1294,\n              columnNumber: 15\n            }, this), /*#__PURE__*/_jsxDEV(motion.button, {\n              whileHover: {\n                scale: 1.05\n              },\n              whileTap: {\n                scale: 0.95\n              },\n              onClick: handleSendMessage,\n              disabled: isLoading || !input.trim() || charCount > MAX_CHARS,\n              className: \"p-2 sm:p-4 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl hover:from-purple-600 hover:to-pink-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed self-end flex items-center justify-center\",\n              children: /*#__PURE__*/_jsxDEV(Send, {\n                className: \"w-5 h-5 sm:w-6 sm:h-6\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 1311,\n                columnNumber: 17\n              }, this)\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1304,\n              columnNumber: 15\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1293,\n            columnNumber: 13\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 1282,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 1224,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 1143,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 1108,\n    columnNumber: 5\n  }, this);\n};\n_s(Chatbot, \"Qmptxp8mQH92hfQVHeT9lFFVilE=\", false, function () {\n  return [useAuth];\n});\n_c = Chatbot;\nexport default Chatbot;\nvar _c;\n$RefreshReg$(_c, \"Chatbot\");","map":{"version":3,"names":["React","useState","useEffect","useRef","motion","AnimatePresence","MessageSquare","Send","ArrowLeft","Sparkles","Plus","Trash2","MessageCircle","ReactMarkdown","remarkGfm","chatWithGemini","logChatMetric","useAuth","doc","getDoc","collection","addDoc","query","orderBy","limit","getDocs","deleteDoc","updateDoc","serverTimestamp","db","ALIMENTOS_DB","foodCategories","getUserPreferences","generatePersonalizedContext","analyzeUserPreferences","jsxDEV","_jsxDEV","searchFoodInLocal","searchTerm","term","toLowerCase","trim","results","forEach","category","items","food","_food$aliases","_food$tags","matchesName","name","includes","matchesAlias","aliases","some","alias","matchesTag","tags","tag","push","categoryName","getFoodNutritionFromLocal","userInput","input","replace","length","icon","calories","protein","carbs","fat","response","slice","getLocalDateString","now","Date","year","getFullYear","month","String","getMonth","padStart","day","getDate","detectRiskQuestion","riskPatterns","pesoRapido","pesoExtremo","eliminarGrupo","ayunoExtremo","caloriasExtremas","ejercicioExtremo","laxantesSupresores","saltarComidas","vomito","trastorno","tipo","pattern","Object","entries","test","console","log","hasRisk","riskType","getRiskWarningResponse","warning","getLocalResponse","userFoodData","userProfile","riskCheck","preguntaSobreComida","meals","allFoods","values","flat","totalCalories","reduce","sum","totalProtein","totalCarbs","totalFat","comidas","key","nombre","icono","comida","item","toFixed","calorieGoal","diff","Math","abs","targetProtein","alimentos","filter","a","resp","alimento","proteinas","calorias","topProtein","sort","b","i","carbohidratos","grasas","match","peruFood","WELCOME_MESSAGE","Chatbot","onBack","userProfileProp","_s","user","conversations","setConversations","activeConversationId","setActiveConversationId","messages","setMessages","id","text","sender","timestamp","toISOString","setInput","isLoading","setIsLoading","setUserFoodData","historyLoaded","setHistoryLoaded","showSidebar","setShowSidebar","window","innerWidth","charCount","setCharCount","userPreferences","setUserPreferences","MAX_CHARS","messagesEndRef","loadChatHistory","chatHistoryRef","uid","q","querySnapshot","empty","historyMessages","data","message","isLocal","reverse","error","loadUserFoodData","today","docRef","docSnap","dataFromFirestore","exists","cached","JSON","parse","localStorage","getItem","e","merged","water","mealTypes","mt","fromFs","fromCache","mapIds","Map","toString","set","has","Array","from","scrollToBottom","_messagesEndRef$curre","current","scrollIntoView","behavior","loadConversations","conversationsRef","convos","loadConversationMessages","createNewConversation","loadUserData","goal","age","weight","height","activityLevel","dailyCalories","selectedFoods","keys","warn","prefs","favoriteFoods","setTimeout","newPrefs","newConvo","title","createdAt","lastUpdated","messageCount","conversationId","messagesRef","msgs","deleteConversation","confirm","messagesSnapshot","Promise","all","docs","map","ref","updatedConvos","c","refreshUserPreferences","saveChatMessage","convoRef","convoSnap","currentData","substring","handleSendMessage","userMessage","prev","startTime1","foodLocalResponse","latency1","botMessage","startTime2","localResponse","latency2","context","mealType","foods","f","join","objetivo","peso","altura","edad","actividad","alimentosFavoritos","personalizedContext","startTime3","latency3","errorText","errorMessage","handleKeyPress","shiftKey","preventDefault","handleInputChange","value","target","className","children","button","whileHover","scale","whileTap","onClick","size","fileName","_jsxFileName","lineNumber","columnNumber","div","initial","x","opacity","animate","convo","stopPropagation","index","percentage","dietType","y","exit","remarkPlugins","style","animationDelay","onChange","onKeyPress","placeholder","rows","disabled","maxLength","_c","$RefreshReg$"],"sources":["C:/xampp/htdocs/FICTIA/src/components/Chatbot.js"],"sourcesContent":["import React, { useState, useEffect, useRef } from 'react';\r\nimport { motion, AnimatePresence } from 'framer-motion';\r\nimport { MessageSquare, Send, ArrowLeft, Sparkles, Plus, Trash2, MessageCircle } from 'lucide-react';\r\nimport ReactMarkdown from 'react-markdown';\r\nimport remarkGfm from 'remark-gfm';\r\nimport { chatWithGemini, logChatMetric } from '../utils/api';\r\nimport { useAuth } from '../contexts/AuthContext';\r\nimport { doc, getDoc, collection, addDoc, query, orderBy, limit, getDocs, deleteDoc, updateDoc, serverTimestamp } from 'firebase/firestore';\r\nimport { db } from '../config/firebase';\r\nimport { ALIMENTOS_DB } from '../data/foodDatabase';\r\nimport { foodCategories } from '../data/foodGallery';\r\nimport { getUserPreferences, generatePersonalizedContext, analyzeUserPreferences } from '../utils/userAnalytics';\r\n\r\n// ğŸ FUNCIÃ“N: Buscar alimentos en la galerÃ­a local\r\nconst searchFoodInLocal = (searchTerm) => {\r\n  const term = searchTerm.toLowerCase().trim();\r\n  const results = [];\r\n  \r\n  foodCategories.forEach(category => {\r\n    category.items.forEach(food => {\r\n      // Buscar por nombre, aliases o tags\r\n      const matchesName = food.name.toLowerCase().includes(term);\r\n      const matchesAlias = food.aliases?.some(alias => alias.toLowerCase().includes(term));\r\n      const matchesTag = food.tags?.some(tag => tag.toLowerCase().includes(term));\r\n      \r\n      if (matchesName || matchesAlias || matchesTag) {\r\n        results.push({\r\n          ...food,\r\n          categoryName: category.name\r\n        });\r\n      }\r\n    });\r\n  });\r\n  \r\n  return results;\r\n};\r\n\r\n// ğŸ½ï¸ FUNCIÃ“N: Generar respuesta nutricional desde base de datos local\r\nconst getFoodNutritionFromLocal = (userInput) => {\r\n  const input = userInput.toLowerCase().trim();\r\n  \r\n  // Extraer posible nombre de alimento\r\n  let searchTerm = input;\r\n  \r\n  // Remover palabras comunes de preguntas\r\n  searchTerm = searchTerm\r\n    .replace(/cuÃ¡nto|cuanto|tiene|contiene|informaciÃ³n|info|dame|dime|sobre|del|de|la|el|un|una|nutriciÃ³n|nutricional|calorÃ­as|calorias|proteÃ­nas|proteinas|carbohidratos|grasas/g, '')\r\n    .trim();\r\n  \r\n  if (!searchTerm || searchTerm.length < 3) {\r\n    return null; // Muy corto para buscar\r\n  }\r\n  \r\n  const results = searchFoodInLocal(searchTerm);\r\n  \r\n  if (results.length === 0) {\r\n    return null; // No encontrado, dejar que Gemini responda\r\n  }\r\n  \r\n  // Si encontramos resultados\r\n  if (results.length === 1) {\r\n    const food = results[0];\r\n    return `${food.icon} **${food.name}** (${food.categoryName})\r\n\r\nğŸ“Š **InformaciÃ³n nutricional** (por 100g):\r\nâ€¢ ğŸ”¥ CalorÃ­as: ${food.calories} kcal\r\nâ€¢ ğŸ’ª ProteÃ­nas: ${food.protein}g\r\nâ€¢ ğŸ Carbohidratos: ${food.carbs}g\r\nâ€¢ ğŸ¥‘ Grasas: ${food.fat}g\r\n\r\nâœ… Esta informaciÃ³n viene de nuestra base de datos local.`;\r\n  }\r\n  \r\n  // MÃºltiples resultados\r\n  let response = `ğŸ” EncontrÃ© **${results.length} alimentos** que coinciden:\\n\\n`;\r\n  results.slice(0, 5).forEach(food => {\r\n    response += `${food.icon} **${food.name}** - ${food.calories} kcal | P:${food.protein}g C:${food.carbs}g G:${food.fat}g\\n`;\r\n  });\r\n  \r\n  if (results.length > 5) {\r\n    response += `\\n...y ${results.length - 5} mÃ¡s. SÃ© mÃ¡s especÃ­fico para ver detalles.`;\r\n  }\r\n  \r\n  return response;\r\n};\r\n\r\n// FunciÃ³n helper para obtener fecha local\r\nconst getLocalDateString = () => {\r\n  const now = new Date();\r\n  const year = now.getFullYear();\r\n  const month = String(now.getMonth() + 1).padStart(2, '0');\r\n  const day = String(now.getDate()).padStart(2, '0');\r\n  return `${year}-${month}-${day}`;\r\n};\r\n\r\n// ğŸ›¡ï¸ SISTEMA DE DETECCIÃ“N DE PREGUNTAS DE RIESGO\r\nconst detectRiskQuestion = (userInput) => {\r\n  const input = userInput.toLowerCase().trim();\r\n  \r\n  // Patrones de riesgo extremo\r\n  const riskPatterns = {\r\n    pesoRapido: /(?:bajar|perder|adelgazar|quemar)\\s*(?:rÃ¡pido|rapido|rÃ¡pidamente|rapidamente)?\\s*(?:\\d+\\s*kg|\\d+\\s*kilos?)\\s*(?:en|por)\\s*(?:una?\\s*semana|dÃ­as?|dia)/i,\r\n    pesoExtremo: /(?:bajar|perder)\\s*(?:10|15|20|\\d{2})\\s*(?:kg|kilos?)\\s*(?:rÃ¡pido|rapido|en\\s*\\d+\\s*(?:semana|dÃ­a|mes))/i,\r\n    eliminarGrupo: /(?:dejar|eliminar|quitar|no\\s*comer|sin)\\s*(?:de\\s*comer\\s*)?(?:carbohidratos?|carbs|pan|arroz|grasas?|proteÃ­nas?|comida)/i,\r\n    ayunoExtremo: /(?:no\\s*comer|dejar\\s*de\\s*comer|ayunar)\\s*(?:nada|todo\\s*el\\s*dÃ­a|varios?\\s*dÃ­as?|una?\\s*semana)/i,\r\n    caloriasExtremas: /(?:comer|consumir)?\\s*(?:solo|menos\\s*de|mÃ¡ximo)?\\s*(?:500|600|700|800|900|1000)\\s*(?:kcal|calorÃ­as?|calorias?)/i,\r\n    ejercicioExtremo: /(?:hacer|entrenar)\\s*(?:mucho|demasiado|todo\\s*el\\s*dÃ­a|\\d+\\s*horas?)\\s*(?:ejercicio|cardio|gym)/i,\r\n    laxantesSupresores: /(?:pastillas?|suplementos?|medicamentos?)\\s*(?:para|de)?\\s*(?:adelgazar|bajar|perder|quemar)/i,\r\n    saltarComidas: /(?:saltar|no\\s*comer|omitir)\\s*(?:el\\s*)?(?:desayuno|almuerzo|cena|comidas?)/i,\r\n    vomito: /(?:vomitar|purgar|laxantes?)\\s*(?:despuÃ©s|para)/i,\r\n    trastorno: /(?:anorexia|bulimia|atracÃ³n|trastorno\\s*alimenticio)/i\r\n  };\r\n  \r\n  // Verificar cada patrÃ³n\r\n  for (const [tipo, pattern] of Object.entries(riskPatterns)) {\r\n    if (pattern.test(input)) {\r\n      console.log('ğŸš¨ ALERTA DE RIESGO DETECTADA:', tipo);\r\n      return { hasRisk: true, riskType: tipo, pattern: input };\r\n    }\r\n  }\r\n  \r\n  return { hasRisk: false };\r\n};\r\n\r\n// ğŸš¨ RESPUESTA PARA PREGUNTAS DE RIESGO\r\nconst getRiskWarningResponse = (riskType, userInput) => {\r\n  let warning = `ğŸš¨ **Ey, para el carro un momento...**\\n\\n`;\r\n  \r\n  if (riskType === 'pesoRapido' || riskType === 'pesoExtremo') {\r\n    warning += `Hermano/a, lo que estÃ¡s preguntando es **peligroso** para tu salud. DÃ©jame explicarte por quÃ©:\\n\\n`;\r\n    warning += `**âŒ Bajar mucho peso muy rÃ¡pido causa:**\\n`;\r\n    warning += `â€¢ Pierdes MÃšSCULO, no solo grasa ğŸ’€\\n`;\r\n    warning += `â€¢ Tu metabolismo se jode permanentemente ğŸ”¥\\n`;\r\n    warning += `â€¢ Te vas a sentir horrible: cansancio, mareos, mal humor\\n`;\r\n    warning += `â€¢ Efecto rebote SEGURO: recuperas todo + kilos extra ğŸ“ˆ\\n\\n`;\r\n    warning += `**âœ… Mejor hagÃ¡moslo bien:**\\n`;\r\n    warning += `â€¢ 0.5-1 kg por semana (es lo saludable) ğŸ“Š\\n`;\r\n    warning += `â€¢ DÃ©ficit suave: -300 a -500 kcal al dÃ­a\\n`;\r\n    warning += `â€¢ Mete harta proteÃ­na para mantener mÃºsculo ğŸ’ª\\n`;\r\n    warning += `â€¢ Entrena con pesas 3-4 veces/semana\\n\\n`;\r\n    warning += `ğŸ’¡ **La neta:** Bajar rÃ¡pido = recuperar TODO mÃ¡s rÃ¡pido. Mejor lento y seguro, Â¿va?\\n\\n`;\r\n    warning += `Â¿Quieres que te arme un plan **sostenible** en lugar de algo extremo? ğŸ¯`;\r\n  }\r\n  \r\n  else if (riskType === 'eliminarGrupo') {\r\n    warning += `Mira bro/sis, entiendo que quieras resultados rÃ¡pidos, pero **eliminar grupos alimenticios completos es mala idea**. Te explico:\\n\\n`;\r\n    warning += `**âŒ Por quÃ© NO eliminarlos:**\\n\\n`;\r\n    warning += `ğŸ **Carbohidratos:**\\n`;\r\n    warning += `â€¢ Tu cerebro y mÃºsculos los NECESITAN para energÃ­a\\n`;\r\n    warning += `â€¢ Sin ellos: cansancio, mal humor, cero fuerza en el gym\\n`;\r\n    warning += `â€¢ Mejor: modera el arroz blanco, pero no lo elimines\\n\\n`;\r\n    warning += `ğŸ¥‘ **Grasas:**\\n`;\r\n    warning += `â€¢ Esenciales para tus hormonas (incluyendo testosterona)\\n`;\r\n    warning += `â€¢ Ayudan a absorber vitaminas\\n`;\r\n    warning += `â€¢ Mejor: palta, aceite de oliva, frutos secos\\n\\n`;\r\n    warning += `ğŸ¥© **ProteÃ­nas:**\\n`;\r\n    warning += `â€¢ Son TU MÃšSCULO literal\\n`;\r\n    warning += `â€¢ Sin ellas pierdes mÃºsculo, no grasa\\n\\n`;\r\n    warning += `**âœ… El truco real:**\\n`;\r\n    warning += `â€¢ Come TODO pero en las cantidades correctas ğŸ“\\n`;\r\n    warning += `â€¢ ProteÃ­na alta, carbos moderados, grasas necesarias\\n`;\r\n    warning += `â€¢ AsÃ­ mantienes mÃºsculo y quemas grasa ğŸ”¥\\n\\n`;\r\n    warning += `ï¿½ Â¿Te ayudo a balancear tu alimentaciÃ³n sin restricciones locas?`;\r\n  }\r\n  \r\n  else if (riskType === 'ayunoExtremo' || riskType === 'saltarComidas') {\r\n    warning += `Bro/sis, lo que estÃ¡s pensando hacer va a **joder tu metabolismo** mal. Te cuento por quÃ©:\\n\\n`;\r\n    warning += `**âŒ No comer = NO es la soluciÃ³n:**\\n`;\r\n    warning += `â€¢ Tu cuerpo entra en \"modo ahorro\" = quema MENOS calorÃ­as ğŸŒ\\n`;\r\n    warning += `â€¢ Pierdes mÃºsculo (que es lo que quema grasa)\\n`;\r\n    warning += `â€¢ Te sientes de la ver**: fatiga, irritabilidad, cero concentraciÃ³n\\n`;\r\n    warning += `â€¢ Terminas con atracones despuÃ©s (pregÃºntale a cualquiera)\\n\\n`;\r\n    warning += `**âœ… Lo que realmente funciona:**\\n`;\r\n    warning += `â€¢ Come 3-4 veces al dÃ­a, comidas normales âœ…\\n`;\r\n    warning += `â€¢ MÃ­nimo: 1200 kcal mujeres / 1500 kcal hombres\\n`;\r\n    warning += `â€¢ Desayuna bien = energÃ­a para todo el dÃ­a ğŸŒ…\\n`;\r\n    warning += `â€¢ ProteÃ­na en cada comida = no tienes hambre\\n\\n`;\r\n    warning += `ğŸ’¡ **Real talk:** No comer no te hace bajar de peso. Comer BIEN sÃ­.\\n\\n`;\r\n    warning += `Â¿Armamos un plan de comidas que realmente funcione? ğŸ½ï¸`;\r\n  }\r\n  \r\n  else if (riskType === 'caloriasExtremas') {\r\n    warning += `Ey ey ey, **esas calorÃ­as son DEMASIADO bajas** para cualquier persona. AsÃ­ no se hace, hermano/a:\\n\\n`;\r\n    warning += `**âŒ Menos de 1200 kcal es peligroso porque:**\\n`;\r\n    warning += `â€¢ No cubres ni lo BÃSICO que tu cuerpo necesita para funcionar ğŸ«€\\n`;\r\n    warning += `â€¢ Tu mÃºsculo se va a la mie*** (literal)\\n`;\r\n    warning += `â€¢ Cansancio extremo, frÃ­o todo el tiempo\\n`;\r\n    warning += `â€¢ Tu sistema inmune se debilita = te enfermas mÃ¡s\\n`;\r\n    warning += `â€¢ Las chicas pueden perder su perÃ­odo ğŸ˜°\\n\\n`;\r\n    warning += `**âœ… CalorÃ­as mÃ­nimas saludables:**\\n`;\r\n    warning += `â€¢ Mujeres: 1200-1500 kcal (mÃ­nimo)\\n`;\r\n    warning += `â€¢ Hombres: 1500-1800 kcal (mÃ­nimo)\\n`;\r\n    warning += `â€¢ Si entrenas: suma 300-500 kcal mÃ¡s\\n\\n`;\r\n    warning += `ğŸ’¡ Tu cuerpo no es tu enemigo. Dale lo que necesita y verÃ¡s resultados REALES.\\n\\n`;\r\n    warning += `Â¿Calculamos TUS calorÃ­as correctas? ğŸ“Š`;\r\n  }\r\n  \r\n  else if (riskType === 'ejercicioExtremo') {\r\n    warning += `Tranqui campeÃ³n/a, **entrenar de mÃ¡s es TAN malo como no entrenar**. Te cuento:\\n\\n`;\r\n    warning += `**âŒ Sobreentrenamiento causa:**\\n`;\r\n    warning += `â€¢ Lesiones por fatiga crÃ³nica ğŸ¤•\\n`;\r\n    warning += `â€¢ Pierdes mÃºsculo en lugar de ganarlo\\n`;\r\n    warning += `â€¢ Sistema inmune dÃ©bil = te enfermas\\n`;\r\n    warning += `â€¢ Insomnio, ansiedad, mal humor ğŸ˜´\\n`;\r\n    warning += `â€¢ Cero progreso (estancamiento total)\\n\\n`;\r\n    warning += `**âœ… Volumen Ã“PTIMO (probado):**\\n`;\r\n    warning += `â€¢ Pesas: 3-5 dÃ­as/semana, 45-60 minutos\\n`;\r\n    warning += `â€¢ Cardio: 2-3 dÃ­as/semana, 30-40 minutos\\n`;\r\n    warning += `â€¢ Descanso: 1-2 dÃ­as OBLIGATORIOS\\n`;\r\n    warning += `â€¢ Dormir: 7-9 horas (ahÃ­ crece el mÃºsculo) ğŸ˜´\\n\\n`;\r\n    warning += `ğŸ’¡ **Real:** El mÃºsculo crece cuando descansas, no cuando entrenas.\\n\\n`;\r\n    warning += `Â¿Quieres un plan de entreno balanceado que funcione? ğŸ’ª`;\r\n  }\r\n  \r\n  else if (riskType === 'laxantesSupresores' || riskType === 'vomito' || riskType === 'trastorno') {\r\n    warning += `ğŸ†˜ **Hermano/a, esto es SERIO. Necesito que me escuches:**\\n\\n`;\r\n    warning += `Lo que estÃ¡s preguntando es **extremadamente peligroso** y puede:\\n\\n`;\r\n    warning += `âŒ DaÃ±ar tu sistema digestivo de forma PERMANENTE\\n`;\r\n    warning += `âŒ Causarte problemas cardÃ­acos (desbalance electrolÃ­tico)\\n`;\r\n    warning += `âŒ Arruinar tus dientes para siempre\\n`;\r\n    warning += `âŒ Desarrollar trastornos alimenticios serios\\n`;\r\n    warning += `âŒ Afectar tu salud mental gravemente\\n\\n`;\r\n    warning += `**ğŸ†˜ Por favor, busca ayuda profesional:**\\n\\n`;\r\n    warning += `Esto suena mÃ¡s serio de lo que yo puedo manejar. Necesitas hablar con:\\n`;\r\n    warning += `â€¢ Un nutricionista certificado\\n`;\r\n    warning += `â€¢ Un psicÃ³logo especializado\\n`;\r\n    warning += `â€¢ Tu mÃ©dico de cabecera\\n\\n`;\r\n    warning += `ğŸ“ **LÃ­neas de ayuda en PerÃº (confidencial):**\\n`;\r\n    warning += `â€¢ EsSalud: **107** (gratis, 24/7)\\n`;\r\n    warning += `â€¢ MINSA Salud Mental: **(01) 284-1349**\\n\\n`;\r\n    warning += `ğŸ’™ **Te lo digo en serio:** Tu salud vale MIL VECES mÃ¡s que cualquier nÃºmero en la balanza.\\n\\n`;\r\n    warning += `No estÃ¡s solo/a en esto. Hay profesionales que pueden ayudarte de verdad. ğŸ¤`;\r\n    return warning;\r\n  }\r\n  \r\n  warning += `\\n\\nâš ï¸ Ojo: Esto es orientaciÃ³n general. Si tienes dudas mÃ©dicas serias, siempre consulta con un profesional.\\n`;\r\n  \r\n  return warning;\r\n};\r\n\r\n// ğŸ§  SISTEMA DE RESPUESTAS INTELIGENTES LOCALES\r\nconst getLocalResponse = (userInput, userFoodData, userProfile) => {\r\n  const input = userInput.toLowerCase().trim();\r\n  \r\n  console.log('ğŸ” Analizando mensaje:', input);\r\n  \r\n  // ===== 0. VERIFICAR PREGUNTAS DE RIESGO PRIMERO =====\r\n  const riskCheck = detectRiskQuestion(input);\r\n  if (riskCheck.hasRisk) {\r\n    console.log('ğŸš¨ Pregunta de RIESGO detectada:', riskCheck.riskType);\r\n    return getRiskWarningResponse(riskCheck.riskType, input);\r\n  }\r\n  \r\n  // ===== 1. ANÃLISIS DE ALIMENTACIÃ“N =====\r\n  const preguntaSobreComida = \r\n    input.includes('comÃ­') || input.includes('comi') || \r\n    input.includes('estÃ¡ bien') || input.includes('esta bien') ||\r\n    input.includes('cÃ³mo voy') || input.includes('como voy') ||\r\n    input.includes('quÃ© tal') || input.includes('que tal') ||\r\n    input.includes('opiniÃ³n') || input.includes('opinion') ||\r\n    (input.includes('hoy') && (input.includes('dÃ­a') || input.includes('dia'))) ||\r\n    input.includes('alimentaciÃ³n') || input.includes('alimentacion') ||\r\n    input.includes('registro');\r\n  \r\n  if (preguntaSobreComida) {\r\n    console.log('âœ… Detectado: pregunta sobre alimentaciÃ³n');\r\n    \r\n    if (!userFoodData || !userFoodData.meals) {\r\n      return `ğŸ“‹ AÃºn no has registrado nada hoy.\\n\\n1. Ve a \"Registro de Alimentos\"\\n2. Agrega lo que comiste\\n3. Presiona \"Guardar Todo\"\\n4. Vuelve y pregÃºntame de nuevo ğŸ˜Š`;\r\n    }\r\n    \r\n    const allFoods = Object.values(userFoodData.meals).flat();\r\n    \r\n    if (allFoods.length === 0) {\r\n      return `ğŸ“‹ AÃºn no has registrado comidas hoy.\\n\\n1. Ve a \"Registro de Alimentos\"\\n2. Agrega lo que comiste\\n3. Presiona \"Guardar Todo\"\\n4. Vuelve y pregÃºntame de nuevo ğŸ˜Š`;\r\n    }\r\n    \r\n    // HAY DATOS - Hacer anÃ¡lisis completo\r\n    const totalCalories = allFoods.reduce((sum, food) => sum + (food.calories || 0), 0);\r\n    const totalProtein = allFoods.reduce((sum, food) => sum + (food.protein || 0), 0);\r\n    const totalCarbs = allFoods.reduce((sum, food) => sum + (food.carbs || 0), 0);\r\n    const totalFat = allFoods.reduce((sum, food) => sum + (food.fat || 0), 0);\r\n    \r\n    let response = `ğŸ“Š **Tu alimentaciÃ³n de hoy:**\\n\\n`;\r\n    \r\n    // Mostrar por comida\r\n    const comidas = [\r\n      { key: 'breakfast', nombre: 'Desayuno', icono: 'ğŸŒ…' },\r\n      { key: 'lunch', nombre: 'Almuerzo', icono: 'ğŸ½ï¸' },\r\n      { key: 'dinner', nombre: 'Cena', icono: 'ğŸŒ™' },\r\n      { key: 'snacks', nombre: 'Meriendas', icono: 'ğŸª' }\r\n    ];\r\n    \r\n    comidas.forEach(comida => {\r\n      const items = userFoodData.meals[comida.key] || [];\r\n      if (items.length > 0) {\r\n        response += `${comida.icono} **${comida.nombre}:**\\n`;\r\n        items.forEach(item => {\r\n          response += `  â€¢ ${item.name} (${item.calories} kcal)\\n`;\r\n        });\r\n        response += `\\n`;\r\n      }\r\n    });\r\n    \r\n    response += `**ğŸ“ˆ Totales:**\\n`;\r\n    response += `â€¢ CalorÃ­as: ${totalCalories.toFixed(0)} kcal\\n`;\r\n    response += `â€¢ ProteÃ­nas: ${totalProtein.toFixed(1)}g\\n`;\r\n    response += `â€¢ Carbos: ${totalCarbs.toFixed(1)}g\\n`;\r\n    response += `â€¢ Grasas: ${totalFat.toFixed(1)}g\\n\\n`;\r\n    \r\n    // EvaluaciÃ³n\r\n    if (userProfile && userProfile.calorieGoal) {\r\n      const diff = totalCalories - userProfile.calorieGoal;\r\n      response += `**ğŸ¯ EvaluaciÃ³n:**\\n`;\r\n      \r\n      if (diff > 300) {\r\n        response += `âš ï¸ Te pasaste ${diff.toFixed(0)} kcal. No hagas de esto un hÃ¡bito.\\n`;\r\n      } else if (diff > 100) {\r\n        response += `â„¹ï¸ EstÃ¡s ${diff.toFixed(0)} kcal arriba. Modera maÃ±ana.\\n`;\r\n      } else if (diff < -300) {\r\n        response += `âš ï¸ Te faltan ${Math.abs(diff).toFixed(0)} kcal. Come mÃ¡s.\\n`;\r\n      } else {\r\n        response += `âœ… Â¡Perfecto! Dentro de tu objetivo.\\n`;\r\n      }\r\n      \r\n      const targetProtein = (userProfile.calorieGoal * 0.30) / 4;\r\n      if (totalProtein < targetProtein * 0.8) {\r\n        response += `ğŸ¥© Baja en proteÃ­na. Agrega pollo/pescado/huevos.\\n`;\r\n      }\r\n    }\r\n    \r\n    return response;\r\n  }\r\n  \r\n  // ===== 2. PREGUNTAS SOBRE PROTEÃNAS =====\r\n  if (input.includes('proteÃ­na') || input.includes('proteina')) {\r\n    console.log('âœ… Detectado: pregunta sobre proteÃ­nas');\r\n    \r\n    // Buscar alimento especÃ­fico mencionado\r\n    const alimentos = ALIMENTOS_DB.filter(a => \r\n      input.includes(a.nombre.toLowerCase())\r\n    );\r\n    \r\n    if (alimentos.length > 0) {\r\n      let resp = '';\r\n      alimentos.slice(0, 3).forEach(alimento => {\r\n        resp += `**${alimento.nombre}:**\\n`;\r\n        resp += `ğŸ¥© ProteÃ­nas: ${alimento.proteinas || 0}g\\n`;\r\n        resp += `ğŸ”¥ ${alimento.calorias} kcal\\n\\n`;\r\n      });\r\n      return resp;\r\n    }\r\n    \r\n    // Lista general de altos en proteÃ­na\r\n    if (input.includes('mÃ¡s') || input.includes('mas') || input.includes('alta') || input.includes('mayor')) {\r\n      const topProtein = ALIMENTOS_DB\r\n        .filter(a => a.proteinas && a.proteinas > 20)\r\n        .sort((a, b) => b.proteinas - a.proteinas)\r\n        .slice(0, 8);\r\n      \r\n      let resp = `ğŸ¥© **Top alimentos en proteÃ­na:**\\n\\n`;\r\n      topProtein.forEach((a, i) => {\r\n        resp += `${i + 1}. ${a.nombre}: ${a.proteinas}g (${a.calorias} kcal)\\n`;\r\n      });\r\n      return resp;\r\n    }\r\n  }\r\n  \r\n  // ===== 3. CALORÃAS DE ALIMENTOS =====\r\n  if (input.includes('calorÃ­as') || input.includes('calorias') || input.includes('kcal')) {\r\n    console.log('âœ… Detectado: pregunta sobre calorÃ­as');\r\n    \r\n    const alimentos = ALIMENTOS_DB.filter(a => \r\n      input.includes(a.nombre.toLowerCase())\r\n    );\r\n    \r\n    if (alimentos.length > 0) {\r\n      let resp = '';\r\n      alimentos.slice(0, 3).forEach(alimento => {\r\n        resp += `**${alimento.nombre}:**\\n`;\r\n        resp += `ğŸ”¥ ${alimento.calorias} kcal\\n`;\r\n        if (alimento.proteinas) resp += `ğŸ¥© ProteÃ­nas: ${alimento.proteinas}g\\n`;\r\n        if (alimento.carbohidratos) resp += `ğŸ Carbos: ${alimento.carbohidratos}g\\n`;\r\n        if (alimento.grasas) resp += `ğŸ¥‘ Grasas: ${alimento.grasas}g\\n`;\r\n        resp += `\\n`;\r\n      });\r\n      return resp;\r\n    }\r\n  }\r\n  \r\n  // ===== 4. DÃ‰FICIT CALÃ“RICO =====\r\n  if (input.includes('dÃ©ficit') || input.includes('deficit') || input.includes('bajar') || input.includes('adelgazar') || input.includes('perder')) {\r\n    console.log('âœ… Detectado: pregunta sobre dÃ©ficit calÃ³rico');\r\n    return `ğŸ¯ **Para dÃ©ficit calÃ³rico:**\\n\\n**âœ… SÃ comer:**\\nâ€¢ Pollo, pescado, claras de huevo\\nâ€¢ Verduras (todas)\\nâ€¢ Bebidas Zero\\nâ€¢ Frutas (moderado)\\n\\n**âŒ EVITAR:**\\nâ€¢ Gaseosas normales (140 kcal vacÃ­as)\\nâ€¢ Frituras\\nâ€¢ Dulces y postres\\nâ€¢ Alcohol\\nâ€¢ Exceso de arroz\\n\\nğŸ’¡ Prioriza proteÃ­na + verduras.`;\r\n  }\r\n  \r\n  // ===== 5. GANAR MÃšSCULO =====\r\n  if (input.includes('mÃºsculo') || input.includes('musculo') || input.includes('masa') || input.includes('volumen') || input.includes('crecer')) {\r\n    console.log('âœ… Detectado: pregunta sobre ganar mÃºsculo');\r\n    return `ğŸ’ª **Para ganar mÃºsculo:**\\n\\n**ProteÃ­na (1.6-2.2g/kg):**\\nâ€¢ Pollo: 35g\\nâ€¢ Huevos (2): 14g\\nâ€¢ Yogurt griego: 12g\\nâ€¢ Pescado: 28g\\n\\n**Carbos post-entreno:**\\nâ€¢ Arroz con pollo: 55g\\nâ€¢ Avena: 50g\\nâ€¢ PlÃ¡tano: 30g\\n\\n**Grasas:**\\nâ€¢ Palta, frutos secos\\n\\nğŸ’¡ Come cada 3-4h y duerme 7-8h.`;\r\n  }\r\n  \r\n  // ===== 6. PREGUNTAS SIMPLES/COMPARACIONES =====\r\n  if (input.match(/^(cual|cuÃ¡l|que|quÃ©)\\s*(tomo|como|es mejor|elijo|escojo|prefiero|recomiendas)$/i)) {\r\n    console.log('âœ… Detectado: pregunta de comparaciÃ³n genÃ©rica');\r\n    return `ğŸ’¡ **Para responder mejor, sÃ© mÃ¡s especÃ­fico:**\\n\\nğŸ¥¤ **Bebidas:**\\nâ€¢ \"Â¿Coca Cola Zero o normal?\"\\nâ€¢ \"Â¿QuÃ© bebida tomar en dÃ©ficit?\"\\n\\nğŸ½ï¸ **Comidas:**\\nâ€¢ \"Â¿Arroz o quinoa?\"\\nâ€¢ \"Â¿QuÃ© comer post-entreno?\"\\n\\nğŸ¥© **ProteÃ­nas:**\\nâ€¢ \"Â¿Pollo o pescado?\"\\nâ€¢ \"Â¿QuÃ© tiene mÃ¡s proteÃ­na?\"\\n\\nÂ¿Sobre quÃ© quieres saber especÃ­ficamente?`;\r\n  }\r\n  \r\n  // ===== 7. SALUDOS =====\r\n  if (input.match(/^(hola|hey|buenas|quÃ© tal|que tal|buenas tardes|buenos dÃ­as|buenos dias|holi|ola)$/)) {\r\n    console.log('âœ… Detectado: saludo');\r\n    return `Â¡Hola! Â¿QuÃ© tal? ğŸ‘‹\\n\\nSoy tu asesor fitness. Puedo ayudarte con todo lo relacionado a nutriciÃ³n:\\n\\nï¿½ **PregÃºntame cosas como:**\\nâ€¢ \"Â¿EstÃ¡ bien lo que comÃ­?\"\\nâ€¢ \"Â¿CuÃ¡ntas calorÃ­as tiene el pollo a la brasa?\"\\nâ€¢ \"Â¿QuÃ© comer para bajar de peso?\"\\nâ€¢ \"Â¿Es malo el arroz en la noche?\"\\nâ€¢ \"Â¿Coca Cola Zero o normal?\"\\n\\nÂ¿En quÃ© te ayudo hoy? ğŸ˜Š`;\r\n  }\r\n  \r\n  // ===== 8. AGRADECIMIENTOS =====\r\n  if (input.match(/^(gracias|thanks|grax|ty|thank you|thx|muchas gracias)$/)) {\r\n    console.log('âœ… Detectado: agradecimiento');\r\n    return `Â¡De nada, bro/sis! ğŸ˜Š Para eso estoy. Si tienes mÃ¡s dudas, aquÃ­ estoy ğŸ’ª`;\r\n  }\r\n  \r\n  // ===== 9. HIDRATACIÃ“N =====\r\n  if (input.includes('agua') || input.includes('hidrat') || input.includes('tomar') || input.includes('beber')) {\r\n    console.log('âœ… Detectado: pregunta sobre hidrataciÃ³n');\r\n    return `ğŸ’§ **HidrataciÃ³n Ã³ptima:**\\n\\n**Meta diaria:** 2.5-3 litros\\n\\n**CuÃ¡ndo beber:**\\nâ€¢ Al despertar: 500ml\\nâ€¢ Antes de entrenar: 300ml\\nâ€¢ Durante entreno: 150ml cada 15min\\nâ€¢ DespuÃ©s: 500ml\\nâ€¢ Con cada comida: 250ml\\n\\n**SeÃ±ales de deshidrataciÃ³n:**\\nâŒ Orina oscura\\nâŒ Sed excesiva\\nâŒ Fatiga\\nâŒ Dolor de cabeza\\n\\nâœ… Orina clara = bien hidratado`;\r\n  }\r\n  \r\n  // ===== 10. SUPLEMENTOS =====\r\n  if (input.includes('suplemento') || input.includes('proteÃ­na en polvo') || input.includes('whey') || input.includes('creatina') || input.includes('pre-workout')) {\r\n    console.log('âœ… Detectado: pregunta sobre suplementos');\r\n    return `ğŸ’Š **Suplementos bÃ¡sicos:**\\n\\n**ESENCIALES:**\\nâœ… ProteÃ­na Whey (si no llegas a meta)\\nâ€¢ 25-30g post-entreno\\nâ€¢ O cuando no puedas comer\\n\\nâœ… Creatina monohidrato\\nâ€¢ 5g diarios (cualquier hora)\\nâ€¢ Mejora fuerza y recuperaciÃ³n\\n\\n**OPCIONALES:**\\nâšª Pre-workout (solo si entrenas muy temprano)\\nâšª Omega 3 (si no comes pescado)\\nâšª Vitamina D (si no tomas sol)\\n\\nâŒ **NO necesitas:** BCAA, glutamina, quemadores\\n\\nğŸ’¡ La comida real siempre es mejor.`;\r\n  }\r\n  \r\n  // ===== 11. HORARIOS DE COMIDA =====\r\n  if (input.includes('cuÃ¡ndo comer') || input.includes('cuando comer') || input.includes('horario') || input.includes('hora') && (input.includes('comer') || input.includes('comida'))) {\r\n    console.log('âœ… Detectado: pregunta sobre horarios');\r\n    return `â° **Horarios de comida Ã³ptimos:**\\n\\n**Para dÃ©ficit calÃ³rico:**\\nğŸŒ… Desayuno: 8-9am (proteÃ­na + carbos)\\nğŸ½ï¸ Almuerzo: 1-2pm (comida grande)\\nğŸŒ™ Cena: 7-8pm (proteÃ­na + verduras)\\n\\n**Para ganar mÃºsculo:**\\nğŸŒ… Desayuno: 7-8am\\nğŸ Snack: 10-11am\\nğŸ½ï¸ Almuerzo: 1-2pm\\nğŸ¥¤ Pre-entreno: 1h antes\\nğŸ’ª Post-entreno: Dentro de 1h\\nğŸŒ™ Cena: 8-9pm\\nğŸ¥› Antes dormir: CaseÃ­na/yogurt\\n\\nğŸ’¡ Come cada 3-4 horas para mantener metabolismo activo.`;\r\n  }\r\n  \r\n  // ===== 12. CHEAT MEAL =====\r\n  if (input.includes('cheat') || input.includes('trampa') || input.includes('romper dieta') || input.includes('pizza') && input.includes('puedo')) {\r\n    console.log('âœ… Detectado: pregunta sobre cheat meal');\r\n    return `ğŸ• **Sobre las comidas trampa:**\\n\\n**Â¿Puedo tener cheat meals?**\\nâœ… SÃ, 1 vez por semana\\n\\n**Reglas:**\\n1. Solo si cumpliste 6 dÃ­as perfecto\\n2. Una comida, NO todo el dÃ­a\\n3. DisfrÃºtala sin culpa\\n4. Vuelve a la dieta al dÃ­a siguiente\\n\\n**Mejor estrategia:**\\nâ€¢ Programa tu cheat meal (sÃ¡bado noche)\\nâ€¢ Come normal el resto del dÃ­a\\nâ€¢ Entrena duro ese dÃ­a\\nâ€¢ No te peses al dÃ­a siguiente (retenciÃ³n de agua)\\n\\nğŸ’¡ Un cheat meal a la semana NO arruina tu progreso.\\nâŒ 3-4 cheat meals SÃ lo arruinan.`;\r\n  }\r\n  \r\n  // ===== 13. EJERCICIO CARDIO =====\r\n  if (input.includes('cardio') || input.includes('correr') || input.includes('caminar') || input.includes('aerÃ³bico') || input.includes('aerobico')) {\r\n    console.log('âœ… Detectado: pregunta sobre cardio');\r\n    return `ğŸƒ **Cardio para resultados:**\\n\\n**Para QUEMAR GRASA:**\\nâœ… LISS (Low Intensity):\\nâ€¢ Caminar rÃ¡pido: 45-60min\\nâ€¢ 3-4 veces/semana\\nâ€¢ En ayunas (opcional)\\n\\nâœ… HIIT (High Intensity):\\nâ€¢ Sprints: 20-30min\\nâ€¢ 2-3 veces/semana\\nâ€¢ Quema mÃ¡s calorÃ­as post-ejercicio\\n\\n**Para MANTENER MÃšSCULO:**\\nâš ï¸ NO excedas:\\nâ€¢ 3-4 sesiones/semana\\nâ€¢ 30-45min mÃ¡ximo\\nâ€¢ Prioriza pesas sobre cardio\\n\\nğŸ’¡ Demasiado cardio = pierdes mÃºsculo\\nğŸ’ª Pesas + dieta > solo cardio`;\r\n  }\r\n  \r\n  // ===== 14. DESCANSO Y SUEÃ‘O =====\r\n  if (input.includes('descanso') || input.includes('dormir') || input.includes('sueÃ±o') || input.includes('recuperaciÃ³n') || input.includes('recuperacion')) {\r\n    console.log('âœ… Detectado: pregunta sobre descanso');\r\n    return `ğŸ˜´ **Descanso y recuperaciÃ³n:**\\n\\n**SUEÃ‘O (crÃ­tico):**\\nâœ… 7-9 horas obligatorias\\nâ€¢ Antes de las 11pm\\nâ€¢ Cuarto oscuro y fresco\\nâ€¢ Sin pantallas 1h antes\\n\\n**DÃAS DE DESCANSO:**\\nâ€¢ MÃ­nimo 1-2 dÃ­as/semana\\nâ€¢ Caminar ligero estÃ¡ bien\\nâ€¢ Estiramientos/yoga ayudan\\n\\n**POR QUÃ‰ IMPORTA:**\\nğŸ’ª El mÃºsculo crece en el descanso, no en el gym\\nğŸ§  Mejora enfoque y energÃ­a\\nâš¡ Previene lesiones\\nğŸ”¥ Optimiza quema de grasa\\n\\nâŒ Menos de 6h = pierdes mÃºsculo y quemas menos grasa`;\r\n  }\r\n  \r\n  // ===== 14. ALCOHOL =====\r\n  if (input.includes('alcohol') || input.includes('cerveza') || input.includes('licor') || input.includes('tomar') && (input.includes('fiesta') || input.includes('drinks'))) {\r\n    console.log('âœ… Detectado: pregunta sobre alcohol');\r\n    return `ğŸº **Alcohol y fitness:**\\n\\n**LA VERDAD DURA:**\\nâŒ Alcohol = veneno para tus objetivos\\nâ€¢ Bloquea sÃ­ntesis de proteÃ­na (mÃºsculo)\\nâ€¢ Aumenta cortisol (estrÃ©s/grasa)\\nâ€¢ Deshidrata severamente\\nâ€¢ CalorÃ­as vacÃ­as (7 kcal/gramo)\\n\\n**SI VAS A TOMAR:**\\nâš ï¸ LimÃ­tate a 1-2 veces/mes\\n\\n**Mejor opciÃ³n:**\\nâ€¢ Vodka/whisky + agua mineral\\nâ€¢ Ron + Coca Zero\\n\\n**PEOR opciÃ³n:**\\nâŒ Cerveza (carbos + alcohol)\\nâŒ CÃ³cteles dulces (azÃºcar + alcohol)\\nâŒ Shots (mucho alcohol rÃ¡pido)\\n\\nğŸ’¡ Una noche de copas = 3 dÃ­as de progreso perdido`;\r\n  }\r\n  \r\n  // ===== 15. BEBIDAS Y GASEOSAS =====\r\n  if (input.includes('inka') || input.includes('coca cola') || input.includes('gaseosa') || input.includes('bebida') || input.includes('refresco') || input.includes('sprite') || input.includes('fanta') || \r\n      (input.match(/^(cual|cuÃ¡l)\\s*(tomo|bebo|es mejor)$/i))) {\r\n    console.log('âœ… Detectado: pregunta sobre bebidas/gaseosas');\r\n    \r\n    if (input.includes('zero') || input.includes('cero') || input.includes('light') || input.includes('diet')) {\r\n      return `âœ… **Bebidas Zero/Light:**\\n\\n**EXCELENTES para dÃ©ficit:**\\nâ€¢ Coca Cola Zero: 0 kcal âœ…\\nâ€¢ Inka Cola Zero: 0 kcal âœ…\\nâ€¢ Sprite Zero: 0 kcal âœ…\\n\\nğŸ’¡ **Son SEGURAS:**\\nâ€¢ No rompen el dÃ©ficit\\nâ€¢ No afectan insulina\\nâ€¢ Ayudan con antojos de dulce\\n\\nâš ï¸ Pero: el agua sigue siendo mejor\\n\\nğŸ’ª Ãšsalas sin culpa en dÃ©ficit.`;\r\n    }\r\n    \r\n    // Si pregunta \"cual tomo\" o similar\r\n    if (input.match(/^(cual|cuÃ¡l)\\s*(tomo|bebo|es mejor)$/i)) {\r\n      return `ğŸ¥¤ **Mi recomendaciÃ³n de bebidas:**\\n\\n**1ï¸âƒ£ MEJOR OPCIÃ“N:**\\nğŸ’§ Agua natural (2-3 litros/dÃ­a)\\n\\n**2ï¸âƒ£ BUENAS OPCIONES:**\\nâœ… Coca Cola Zero: 0 kcal\\nâœ… Inka Cola Zero: 0 kcal  \\nâœ… Sprite Zero: 0 kcal\\nâœ… CafÃ© negro: 0 kcal\\nâœ… TÃ© verde/negro: 0 kcal\\n\\n**3ï¸âƒ£ EVITAR:**\\nâŒ Coca Cola normal: 210 kcal\\nâŒ Inka Cola normal: 230 kcal\\nâŒ Jugos procesados: 150-200 kcal\\nâŒ NÃ©ctares: 180 kcal\\n\\nğŸ’¡ **Para dÃ©ficit calÃ³rico:** Solo agua y bebidas Zero.\\nğŸ’ª **Para ganar mÃºsculo:** Puedes tomar 1 gaseosa normal post-entreno (carbos rÃ¡pidos).`;\r\n    }\r\n    \r\n    return `âŒ **Bebidas azucaradas:**\\n\\n**Coca Cola normal (500ml):**\\nâ€¢ 210 calorÃ­as\\nâ€¢ 55g azÃºcar\\nâ€¢ âŒ CERO nutrientes\\n\\n**Inka Cola normal (500ml):**\\nâ€¢ 230 calorÃ­as  \\nâ€¢ 58g azÃºcar\\nâ€¢ âŒ CERO nutrientes\\n\\n**ALTERNATIVAS:**\\nâœ… Coca Cola Zero: 0 kcal\\nâœ… Inka Cola Zero: 0 kcal\\nâœ… Agua con limÃ³n\\nâœ… TÃ© helado sin azÃºcar\\n\\nğŸ’¡ Una gaseosa normal = 30 minutos de cardio desperdiciados.\\n\\n**Para dÃ©ficit calÃ³rico:** SOLO bebidas Zero.`;\r\n  }\r\n  \r\n  // ===== 16. COMIDA PERUANA ESPECÃFICA =====\r\n  if (input.includes('ceviche') || input.includes('lomo saltado') || input.includes('ajÃ­ de gallina') || input.includes('aji de gallina') || input.includes('pollo a la brasa') || input.includes('anticucho')) {\r\n    console.log('âœ… Detectado: pregunta sobre comida peruana');\r\n    \r\n    let peruFood = '';\r\n    \r\n    if (input.includes('ceviche')) {\r\n      peruFood = `ğŸŸ **Ceviche:**\\nâœ… EXCELENTE para dÃ©ficit\\nâ€¢ ~250 kcal/porciÃ³n\\nâ€¢ 35g proteÃ­na\\nâ€¢ Bajo en grasa\\n\\nğŸ’¡ Evita el camote/choclo si estÃ¡s en dÃ©ficit`;\r\n    } else if (input.includes('lomo saltado')) {\r\n      peruFood = `ğŸ– **Lomo Saltado:**\\nâš ï¸ MODERADO\\nâ€¢ ~450-550 kcal/porciÃ³n\\nâ€¢ 30g proteÃ­na\\nâ€¢ Alto en aceite\\n\\nğŸ’¡ Pide menos papas, mÃ¡s carne`;\r\n    } else if (input.includes('ajÃ­') || input.includes('aji')) {\r\n      peruFood = `ğŸ— **AjÃ­ de Gallina:**\\nâš ï¸ ALTO EN CALORÃAS\\nâ€¢ ~600 kcal/porciÃ³n\\nâ€¢ Mucha crema y aceite\\n\\nğŸ’¡ Solo para cheat meal o bulking`;\r\n    } else if (input.includes('pollo a la brasa')) {\r\n      peruFood = `ğŸ— **Pollo a la Brasa:**\\nâœ… BUENO (sin piel)\\nâ€¢ 1/4 pollo sin piel: ~300 kcal\\nâ€¢ 40g proteÃ­na\\n\\nâŒ Evita: papas fritas, cremas\\nâœ… Pide: ensalada, sin piel`;\r\n    } else if (input.includes('anticucho')) {\r\n      peruFood = `ä¸² **Anticuchos:**\\nâœ… EXCELENTE\\nâ€¢ 3 anticuchos: ~250 kcal\\nâ€¢ 28g proteÃ­na\\nâ€¢ Bajo en grasa\\n\\nğŸ’¡ Perfecto para post-entreno`;\r\n    }\r\n    \r\n    return peruFood;\r\n  }\r\n  \r\n  // ===== 17. AYUNO INTERMITENTE =====\r\n  if (input.includes('ayuno') || input.includes('intermitente') || input.includes('16/8') || input.includes('no desayuno')) {\r\n    console.log('âœ… Detectado: pregunta sobre ayuno');\r\n    return `â±ï¸ **Ayuno Intermitente:**\\n\\n**Â¿Funciona?**\\nâœ… SÃ, si te ayuda a comer menos calorÃ­as\\nâŒ NO es mÃ¡gico\\n\\n**Protocolo 16/8 (mÃ¡s comÃºn):**\\nâ€¢ Ayuno: 8pm - 12pm (16 horas)\\nâ€¢ Ventana: 12pm - 8pm (8 horas)\\n\\n**VENTAJAS:**\\nâ€¢ MÃ¡s fÃ¡cil estar en dÃ©ficit\\nâ€¢ Menos comidas que preparar\\nâ€¢ Claridad mental en ayunas\\n\\n**DESVENTAJAS:**\\nâŒ DifÃ­cil para ganar mÃºsculo\\nâŒ Posible pÃ©rdida de mÃºsculo\\nâŒ Poca energÃ­a para entrenar\\n\\nğŸ’¡ **MI CONSEJO:**\\nSolo Ãºsalo si te facilita el dÃ©ficit calÃ³rico.\\nPara ganar mÃºsculo â†’ come 4-5 veces/dÃ­a.`;\r\n  }\r\n  \r\n  // ===== 18. MESETA/PLATEAU =====\r\n  if (input.includes('meseta') || input.includes('estancado') || input.includes('no bajo') || input.includes('no pierdo') || input.includes('plateau')) {\r\n    console.log('âœ… Detectado: pregunta sobre meseta');\r\n    return `ğŸ“Š **Rompiendo la meseta:**\\n\\n**Â¿Por quÃ© pasa?**\\nTu cuerpo se adaptÃ³. Necesitas cambios.\\n\\n**SOLUCIONES:**\\n\\n1ï¸âƒ£ **Recalcula tus calorÃ­as:**\\n   â€¢ Pesaste menos â†’ necesitas menos calorÃ­as\\n   â€¢ Reduce 100-200 kcal mÃ¡s\\n\\n2ï¸âƒ£ **Aumenta actividad:**\\n   â€¢ +10min cardio\\n   â€¢ +5,000 pasos diarios\\n\\n3ï¸âƒ£ **Refeed estratÃ©gico:**\\n   â€¢ 1 dÃ­a come a mantenimiento\\n   â€¢ Resetea hormonas (leptina)\\n\\n4ï¸âƒ£ **Revisa TODO lo que comes:**\\n   â€¢ Aceites, aderezos, \"probaditas\"\\n   â€¢ Pesa tu comida 1 semana\\n\\n5ï¸âƒ£ **Duerme mÃ¡s:**\\n   â€¢ Menos de 7h = mÃ¡s cortisol = guardas grasa\\n\\nğŸ’ª Dale 2 semanas con los cambios antes de rendirte.`;\r\n  }\r\n  \r\n  // ===== 19. ANTOJOS =====\r\n  if (input.includes('antojo') || input.includes('ansiedad') || input.includes('hambre') && input.includes('todo el tiempo')) {\r\n    console.log('âœ… Detectado: pregunta sobre antojos');\r\n    return `ğŸ« **Controlando antojos:**\\n\\n**ESTRATEGIAS QUE FUNCIONAN:**\\n\\n1ï¸âƒ£ **Come mÃ¡s proteÃ­na:**\\n   â€¢ 30g en cada comida\\n   â€¢ Te mantiene lleno por horas\\n\\n2ï¸âƒ£ **Toma mÃ¡s agua:**\\n   â€¢ 500ml antes de cada comida\\n   â€¢ A veces es sed, no hambre\\n\\n3ï¸âƒ£ **Duerme suficiente:**\\n   â€¢ Menos de 7h = +25% antojos\\n   â€¢ Sube grelina (hormona del hambre)\\n\\n4ï¸âƒ£ **Alimentos voluminosos:**\\n   â€¢ Verduras (comes mucho, pocas calorÃ­as)\\n   â€¢ Palomitas sin mantequilla\\n   â€¢ Gelatina light\\n\\n5ï¸âƒ£ **Chicles sin azÃºcar:**\\n   â€¢ EngaÃ±a al cerebro\\n\\n6ï¸âƒ£ **Snacks de emergencia:**\\n   â€¢ Zanahoria + hummus\\n   â€¢ Pepino + tajÃ­n\\n   â€¢ Manzana + mantequilla de manÃ­ (1 cucharada)\\n\\nğŸ’¡ Si tienes antojo de algo especÃ­fico, cÃ³melo en pequeÃ±a cantidad.\\nEs mejor 2 cuadros de chocolate que comerte todo el refrigerador despuÃ©s.`;\r\n  }\r\n  \r\n  // ===== 21. NO ENTENDIÃ“ - Usar API =====\r\n  console.log('âš ï¸ No categorizado, usando API Gemini...');\r\n  return null; // Esto harÃ¡ que el sistema use la API\r\n};\r\n\r\n// Usamos `react-markdown` con `remark-gfm` para renderizado seguro y completo de Markdown\r\n\r\n// Mensaje de bienvenida\r\nconst WELCOME_MESSAGE = `Â¡QuÃ© onda! ğŸ‘‹ Soy tu asesor fitness personal en SnorxFit.\r\n\r\nEstoy aquÃ­ para ayudarte con tu alimentaciÃ³n y nutriciÃ³n. Tengo info de +220 alimentos peruanos e internacionales.\r\n\r\nï¿½ **PregÃºntame lo que sea, por ejemplo:**\r\n\r\nğŸ”¥ **Sobre tu alimentaciÃ³n:**\r\nâ€¢ \"Â¿EstÃ¡ bien lo que comÃ­ hoy?\"\r\nâ€¢ \"Â¿CÃ³mo voy con mis calorÃ­as?\"\r\n\r\nğŸ¥© **Info de alimentos:**\r\nâ€¢ \"Â¿CuÃ¡ntas calorÃ­as tiene el lomo saltado?\"\r\nâ€¢ \"Â¿QuÃ© tiene mÃ¡s proteÃ­na, pollo o pescado?\"\r\n\r\nğŸ’ª **Para tus objetivos:**\r\nâ€¢ \"Â¿QuÃ© comer para bajar de peso?\"\r\nâ€¢ \"Â¿CÃ³mo ganar mÃºsculo sin engordar?\"\r\n\r\nğŸ¥¤ **Comparaciones:**\r\nâ€¢ \"Â¿Coca Cola o Coca Zero?\"\r\nâ€¢ \"Â¿Es malo comer arroz en la noche?\"\r\n\r\nHabla normal, sin miedo. Estoy para ayudarte ğŸ˜Š`;\r\n\r\nconst Chatbot = ({ onBack, userProfile: userProfileProp }) => {\r\n  const { user } = useAuth();\r\n  const [conversations, setConversations] = useState([]);\r\n  const [activeConversationId, setActiveConversationId] = useState(null);\r\n  const [messages, setMessages] = useState([\r\n    { id: 1, text: WELCOME_MESSAGE, sender: 'bot', timestamp: new Date().toISOString() }\r\n  ]);\r\n  const [input, setInput] = useState('');\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [userFoodData, setUserFoodData] = useState(null);\r\n  const [historyLoaded, setHistoryLoaded] = useState(false);\r\n  const [showSidebar, setShowSidebar] = useState(typeof window !== 'undefined' ? window.innerWidth >= 768 : true);\r\n  const [charCount, setCharCount] = useState(0);\r\n  const [userPreferences, setUserPreferences] = useState(null);\r\n  // userProfile viene del prop, no del state local\r\n  const MAX_CHARS = 500;\r\n  const messagesEndRef = useRef(null);\r\n\r\n  // Cargar historial de chat desde Firebase\r\n  useEffect(() => {\r\n    const loadChatHistory = async () => {\r\n      if (!user || historyLoaded) return;\r\n      \r\n      try {\r\n        const chatHistoryRef = collection(db, 'users', user.uid, 'chatHistory');\r\n        const q = query(chatHistoryRef, orderBy('timestamp', 'desc'), limit(50));\r\n        const querySnapshot = await getDocs(q);\r\n        \r\n        if (!querySnapshot.empty) {\r\n          const historyMessages = [];\r\n          querySnapshot.forEach((doc) => {\r\n            const data = doc.data();\r\n            historyMessages.push({\r\n              id: doc.id,\r\n              text: data.message,\r\n              sender: data.sender,\r\n              timestamp: data.timestamp,\r\n              isLocal: data.isLocal || false\r\n            });\r\n          });\r\n          \r\n          // Invertir para orden cronolÃ³gico\r\n          historyMessages.reverse();\r\n          \r\n          // Agregar mensaje de bienvenida + historial\r\n          setMessages([\r\n            { id: 'welcome', text: WELCOME_MESSAGE, sender: 'bot', timestamp: new Date().toISOString() },\r\n            ...historyMessages\r\n          ]);\r\n          \r\n          console.log('ğŸ’¬ Historial de chat cargado:', historyMessages.length, 'mensajes');\r\n        }\r\n        \r\n        setHistoryLoaded(true);\r\n      } catch (error) {\r\n        console.error('âŒ Error cargando historial:', error);\r\n        setHistoryLoaded(true);\r\n      }\r\n    };\r\n    \r\n    loadChatHistory();\r\n  }, [user, historyLoaded]);\r\n\r\n  // Cargar datos de alimentaciÃ³n del usuario\r\n  useEffect(() => {\r\n    const loadUserFoodData = async () => {\r\n      if (!user) return;\r\n\r\n      try {\r\n        const today = getLocalDateString();\r\n        const docRef = doc(db, 'users', user.uid, 'foodLogs', today);\r\n        const docSnap = await getDoc(docRef);\r\n\r\n        let dataFromFirestore = null;\r\n        if (docSnap.exists()) {\r\n          dataFromFirestore = docSnap.data();\r\n          console.log('ğŸ“Š Datos de alimentaciÃ³n cargados desde Firestore:', dataFromFirestore);\r\n        } else {\r\n          console.log('ï¿½ No hay datos de alimentaciÃ³n en Firestore para hoy');\r\n        }\r\n\r\n        // Leer cache local y fusionar para que el chatbot tenga siempre la info mÃ¡s completa\r\n        let cached = null;\r\n        try {\r\n          cached = JSON.parse(localStorage.getItem(`foodLog_${today}`) || 'null');\r\n        } catch (e) {\r\n          cached = null;\r\n        }\r\n\r\n        if (cached && cached.meals) {\r\n          // Si no hay datos en Firestore, usar cache directo\r\n          if (!dataFromFirestore) {\r\n            setUserFoodData(cached);\r\n            console.log('ï¿½ Usando cache local para userFoodData:', cached);\r\n          } else {\r\n            // Fusionar arrays por tipo de comida evitando duplicados por id o name\r\n            const merged = { meals: {}, water: cached.water || dataFromFirestore.water || 0 };\r\n            const mealTypes = ['breakfast','lunch','dinner','snacks'];\r\n            mealTypes.forEach(mt => {\r\n              const fromFs = (dataFromFirestore.meals && dataFromFirestore.meals[mt]) || [];\r\n              const fromCache = (cached.meals && cached.meals[mt]) || [];\r\n              const mapIds = new Map();\r\n              fromFs.forEach(item => {\r\n                const key = item.id || (item.name && item.name.toString().toLowerCase());\r\n                if (key) mapIds.set(key, item);\r\n              });\r\n              fromCache.forEach(item => {\r\n                const key = item.id || (item.name && item.name.toString().toLowerCase());\r\n                if (key && !mapIds.has(key)) {\r\n                  mapIds.set(key, item);\r\n                }\r\n              });\r\n              merged.meals[mt] = Array.from(mapIds.values());\r\n            });\r\n            setUserFoodData(merged);\r\n            console.log('ğŸ”€ userFoodData fusionado (Firestore + cache):', merged);\r\n          }\r\n        } else if (dataFromFirestore) {\r\n          setUserFoodData(dataFromFirestore);\r\n          console.log('ğŸ“Š userFoodData establecido desde Firestore');\r\n        } else {\r\n          setUserFoodData(null);\r\n          console.log('ğŸ“‹ No hay datos de alimentaciÃ³n disponibles (ni Firestore ni cache)');\r\n        }\r\n      } catch (error) {\r\n        console.error('âŒ Error cargando datos:', error);\r\n      }\r\n    };\r\n    \r\n    loadUserFoodData();\r\n  }, [user]);\r\n\r\n  const scrollToBottom = () => {\r\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n  };\r\n\r\n  useEffect(() => {\r\n    scrollToBottom();\r\n  }, [messages]);\r\n\r\n  // Cargar conversaciones del usuario\r\n  useEffect(() => {\r\n    const loadConversations = async () => {\r\n      if (!user) return;\r\n      \r\n      try {\r\n        const conversationsRef = collection(db, 'users', user.uid, 'conversations');\r\n        const q = query(conversationsRef, orderBy('lastUpdated', 'desc'), limit(20));\r\n        const querySnapshot = await getDocs(q);\r\n        \r\n        const convos = [];\r\n        querySnapshot.forEach((doc) => {\r\n          convos.push({\r\n            id: doc.id,\r\n            ...doc.data()\r\n          });\r\n        });\r\n        \r\n        setConversations(convos);\r\n        \r\n        // Si no hay conversaciÃ³n activa, crear una nueva\r\n        if (!activeConversationId && convos.length > 0) {\r\n          setActiveConversationId(convos[0].id);\r\n          loadConversationMessages(convos[0].id);\r\n        } else if (convos.length === 0) {\r\n          createNewConversation();\r\n        }\r\n      } catch (error) {\r\n        console.error('âŒ Error cargando conversaciones:', error);\r\n      }\r\n    };\r\n    \r\n    loadConversations();\r\n  }, [user]);\r\n\r\n  // Cargar preferencias y perfil del usuario\r\n  useEffect(() => {\r\n    const loadUserData = async () => {\r\n      if (!user) return;\r\n      \r\n      try {\r\n        // El perfil viene como prop desde App.js, solo cargamos preferencias\r\n        console.log('ğŸ‘¤ Usando perfil del prop:', userProfileProp);\r\n        if (userProfileProp) {\r\n          console.log('  âœ… Nombre:', userProfileProp.name);\r\n          console.log('  âœ… Objetivo:', userProfileProp.goal);\r\n          console.log('  âœ… Edad:', userProfileProp.age);\r\n          console.log('  âœ… Peso:', userProfileProp.weight);\r\n          console.log('  âœ… Altura:', userProfileProp.height);\r\n          console.log('  âœ… Actividad:', userProfileProp.activityLevel);\r\n          console.log('  âœ… CalorÃ­as diarias:', userProfileProp.dailyCalories);\r\n          console.log('  âœ… Alimentos favoritos:', userProfileProp.selectedFoods ? Object.keys(userProfileProp.selectedFoods).length : 0);\r\n        } else {\r\n          console.warn('âš ï¸ No se recibiÃ³ userProfile como prop');\r\n        }\r\n        \r\n        // Cargar o generar preferencias del usuario\r\n        const prefs = await getUserPreferences(user.uid);\r\n        setUserPreferences(prefs);\r\n        console.log('ğŸ¯ Preferencias del usuario cargadas:', prefs);\r\n        \r\n        // Si no hay preferencias, analizar despuÃ©s de 3 segundos\r\n        if (!prefs || !prefs.favoriteFoods || prefs.favoriteFoods.length === 0) {\r\n          console.log('â³ Generando anÃ¡lisis de preferencias...');\r\n          setTimeout(async () => {\r\n            const newPrefs = await analyzeUserPreferences(user.uid, 30);\r\n            setUserPreferences(newPrefs);\r\n            console.log('âœ… Preferencias generadas:', newPrefs);\r\n          }, 3000);\r\n        }\r\n      } catch (error) {\r\n        console.error('âŒ Error cargando datos de usuario:', error);\r\n      }\r\n    };\r\n    \r\n    loadUserData();\r\n  }, [user]);\r\n\r\n  // Crear nueva conversaciÃ³n\r\n  const createNewConversation = async () => {\r\n    if (!user) return;\r\n    \r\n    try {\r\n      const conversationsRef = collection(db, 'users', user.uid, 'conversations');\r\n      const newConvo = await addDoc(conversationsRef, {\r\n        title: 'Nueva conversaciÃ³n',\r\n        createdAt: serverTimestamp(),\r\n        lastUpdated: serverTimestamp(),\r\n        messageCount: 0\r\n      });\r\n      \r\n      setActiveConversationId(newConvo.id);\r\n      setMessages([\r\n        { id: 'welcome', text: WELCOME_MESSAGE, sender: 'bot', timestamp: new Date().toISOString() }\r\n      ]);\r\n      \r\n      // Recargar lista\r\n      const q = query(conversationsRef, orderBy('lastUpdated', 'desc'), limit(20));\r\n      const querySnapshot = await getDocs(q);\r\n      const convos = [];\r\n      querySnapshot.forEach((doc) => {\r\n        convos.push({ id: doc.id, ...doc.data() });\r\n      });\r\n      setConversations(convos);\r\n      \r\n      console.log('âœ… Nueva conversaciÃ³n creada');\r\n    } catch (error) {\r\n      console.error('âŒ Error creando conversaciÃ³n:', error);\r\n    }\r\n  };\r\n\r\n  // Cargar mensajes de una conversaciÃ³n\r\n  const loadConversationMessages = async (conversationId) => {\r\n    if (!user) return;\r\n    \r\n    try {\r\n      const messagesRef = collection(db, 'users', user.uid, 'conversations', conversationId, 'messages');\r\n      const q = query(messagesRef, orderBy('timestamp', 'asc'), limit(100));\r\n      const querySnapshot = await getDocs(q);\r\n      \r\n      const msgs = [\r\n        { id: 'welcome', text: WELCOME_MESSAGE, sender: 'bot', timestamp: new Date().toISOString() }\r\n      ];\r\n      \r\n      querySnapshot.forEach((doc) => {\r\n        const data = doc.data();\r\n        msgs.push({\r\n          id: doc.id,\r\n          text: data.message,\r\n          sender: data.sender,\r\n          timestamp: data.timestamp,\r\n          isLocal: data.isLocal || false\r\n        });\r\n      });\r\n      \r\n      setMessages(msgs);\r\n      setActiveConversationId(conversationId);\r\n    } catch (error) {\r\n      console.error('âŒ Error cargando mensajes:', error);\r\n    }\r\n  };\r\n\r\n  // Eliminar conversaciÃ³n\r\n  const deleteConversation = async (conversationId) => {\r\n    if (!window.confirm('Â¿Eliminar esta conversaciÃ³n?')) return;\r\n    \r\n    try {\r\n      // Eliminar mensajes\r\n      const messagesRef = collection(db, 'users', user.uid, 'conversations', conversationId, 'messages');\r\n      const messagesSnapshot = await getDocs(messagesRef);\r\n      await Promise.all(messagesSnapshot.docs.map(doc => deleteDoc(doc.ref)));\r\n      \r\n      // Eliminar conversaciÃ³n\r\n      await deleteDoc(doc(db, 'users', user.uid, 'conversations', conversationId));\r\n      \r\n      // Actualizar UI\r\n      const updatedConvos = conversations.filter(c => c.id !== conversationId);\r\n      setConversations(updatedConvos);\r\n      \r\n      if (activeConversationId === conversationId) {\r\n        if (updatedConvos.length > 0) {\r\n          loadConversationMessages(updatedConvos[0].id);\r\n        } else {\r\n          createNewConversation();\r\n        }\r\n      }\r\n      \r\n      console.log('âœ… ConversaciÃ³n eliminada');\r\n    } catch (error) {\r\n      console.error('âŒ Error eliminando:', error);\r\n    }\r\n  };\r\n\r\n  // FunciÃ³n para refrescar preferencias del usuario\r\n  const refreshUserPreferences = async () => {\r\n    if (!user) return;\r\n    \r\n    try {\r\n      console.log('ğŸ”„ Actualizando preferencias del usuario...');\r\n      const newPrefs = await analyzeUserPreferences(user.uid, 30);\r\n      setUserPreferences(newPrefs);\r\n      console.log('âœ… Preferencias actualizadas:', newPrefs);\r\n    } catch (error) {\r\n      console.error('âŒ Error actualizando preferencias:', error);\r\n    }\r\n  };\r\n\r\n  // FunciÃ³n para guardar mensajes en Firebase\r\n  const saveChatMessage = async (message, sender, isLocal = false) => {\r\n    if (!user || !activeConversationId) return;\r\n    \r\n    try {\r\n      // Guardar mensaje\r\n      const messagesRef = collection(db, 'users', user.uid, 'conversations', activeConversationId, 'messages');\r\n      await addDoc(messagesRef, {\r\n        message,\r\n        sender,\r\n        isLocal,\r\n        timestamp: serverTimestamp()\r\n      });\r\n      \r\n      // Actualizar conversaciÃ³n\r\n      const convoRef = doc(db, 'users', user.uid, 'conversations', activeConversationId);\r\n      const convoSnap = await getDoc(convoRef);\r\n      const currentData = convoSnap.data();\r\n      \r\n      // TÃ­tulo automÃ¡tico del primer mensaje del usuario\r\n      let title = currentData.title;\r\n      if (title === 'Nueva conversaciÃ³n' && sender === 'user') {\r\n        title = message.substring(0, 40) + (message.length > 40 ? '...' : '');\r\n      }\r\n      \r\n      await updateDoc(convoRef, {\r\n        lastUpdated: serverTimestamp(),\r\n        messageCount: (currentData.messageCount || 0) + 1,\r\n        title\r\n      });\r\n      \r\n      console.log('ğŸ’¾ Mensaje guardado en conversaciÃ³n');\r\n    } catch (error) {\r\n      console.error('âŒ Error guardando mensaje:', error);\r\n    }\r\n  };\r\n\r\n  const handleSendMessage = async () => {\r\n    if (!input.trim()) return;\r\n\r\n    const userMessage = {\r\n      id: messages.length + 1,\r\n      text: input,\r\n      sender: 'user',\r\n      timestamp: new Date().toISOString()\r\n    };\r\n\r\n    setMessages(prev => [...prev, userMessage]);\r\n    const userInput = input;\r\n    setInput('');\r\n    setCharCount(0); // Resetear contador\r\n\r\n    // Guardar mensaje del usuario\r\n    await saveChatMessage(userInput, 'user');\r\n\r\n    // ğŸ PASO 1: Intentar buscar en GALERÃA LOCAL de alimentos\r\n    console.log('ğŸ” Buscando en base de datos local de alimentos...');\r\n    const startTime1 = Date.now();\r\n    const foodLocalResponse = getFoodNutritionFromLocal(userInput);\r\n    const latency1 = Date.now() - startTime1;\r\n    \r\n    if (foodLocalResponse) {\r\n      console.log('âœ… Â¡Alimento encontrado en base de datos local!');\r\n      await logChatMetric('local_food', latency1, true, user?.uid);\r\n      \r\n      const botMessage = {\r\n        id: messages.length + 2,\r\n        text: foodLocalResponse,\r\n        sender: 'bot',\r\n        isLocal: true,\r\n        timestamp: new Date().toISOString()\r\n      };\r\n      setMessages(prev => [...prev, botMessage]);\r\n      \r\n      // Guardar respuesta del bot\r\n      await saveChatMessage(foodLocalResponse, 'bot', true);\r\n      return; // No usar API si hay respuesta local\r\n    }\r\n\r\n    // ğŸš€ PASO 2: Intentar respuestas predefinidas locales (INSTANTÃNEA)\r\n    console.log('ğŸ”„ Intentando respuestas predefinidas locales...');\r\n    const startTime2 = Date.now();\r\n    const localResponse = getLocalResponse(userInput, userFoodData, userProfileProp);\r\n    const latency2 = Date.now() - startTime2;\r\n    \r\n    if (localResponse) {\r\n      console.log('âœ… Respuesta local predefinida encontrada!');\r\n      await logChatMetric('local_predefined', latency2, true, user?.uid);\r\n      \r\n      const botMessage = {\r\n        id: messages.length + 2,\r\n        text: localResponse,\r\n        sender: 'bot',\r\n        isLocal: true,\r\n        timestamp: new Date().toISOString()\r\n      };\r\n      setMessages(prev => [...prev, botMessage]);\r\n      \r\n      // Guardar respuesta del bot\r\n      await saveChatMessage(localResponse, 'bot', true);\r\n      return; // No usar API si hay respuesta local\r\n    }\r\n\r\n    // ğŸ“¡ PASO 3: Solo si no hay respuesta local, usar API de Gemini\r\n    console.log('ğŸ“¡ No hay respuesta local, consultando Gemini API...');\r\n    setIsLoading(true);\r\n\r\n    try {\r\n      // Crear contexto con los datos del usuario\r\n      let context = '';\r\n      \r\n      if (userFoodData && userFoodData.meals) {\r\n        const allFoods = Object.values(userFoodData.meals).flat();\r\n        if (allFoods.length > 0) {\r\n          context += '\\n\\nRegistro de alimentaciÃ³n de hoy del usuario:\\n';\r\n          Object.entries(userFoodData.meals).forEach(([mealType, foods]) => {\r\n            if (foods.length > 0) {\r\n              context += `${mealType}: ${foods.map(f => f.name).join(', ')}\\n`;\r\n            }\r\n          });\r\n        }\r\n      }\r\n      \r\n      if (userProfileProp && userProfileProp.calorieGoal) {\r\n        context += `\\nObjetivo calÃ³rico del usuario: ${userProfileProp.calorieGoal} kcal`;\r\n      }\r\n\r\n      // ğŸ¯ Agregar contexto personalizado basado en el perfil del usuario\r\n      // SIEMPRE generamos contexto si hay userProfile (preferences es opcional)\r\n      if (userProfileProp) {\r\n        console.log('ğŸ¯ Generando contexto personalizado...');\r\n        console.log('ğŸ“‹ Perfil del usuario:', {\r\n          nombre: userProfileProp.name,\r\n          objetivo: userProfileProp.goal,\r\n          peso: userProfileProp.weight,\r\n          altura: userProfileProp.height,\r\n          edad: userProfileProp.age,\r\n          actividad: userProfileProp.activityLevel,\r\n          calorias: userProfileProp.dailyCalories,\r\n          alimentosFavoritos: userProfileProp.selectedFoods ? Object.keys(userProfileProp.selectedFoods).length : 0\r\n        });\r\n        \r\n        // Generar contexto incluso si userPreferences es null\r\n        const personalizedContext = generatePersonalizedContext(userProfileProp, userPreferences, userFoodData);\r\n        context += '\\n\\n' + personalizedContext;\r\n        \r\n        console.log('âœ¨ Contexto personalizado agregado (primeros 400 caracteres):');\r\n        console.log(personalizedContext.substring(0, 400) + '...');\r\n        console.log('ğŸ“ Longitud total del contexto:', personalizedContext.length, 'caracteres');\r\n      } else {\r\n        console.warn('âš ï¸ No se pudo generar contexto personalizado:');\r\n        console.warn('  - userProfile existe?', !!userProfileProp);\r\n        console.warn('  - userPreferences existe?', !!userPreferences);\r\n      }\r\n\r\n      console.log('ğŸ¤– Llamando a Gemini API con contexto personalizado...');\r\n      console.log('ğŸ“¤ Prompt completo enviado a Gemini (primeros 300 caracteres):');\r\n      console.log((userInput + context).substring(0, 300) + '...');\r\n      const startTime3 = Date.now();\r\n      const response = await chatWithGemini(userInput + context);\r\n      const latency3 = Date.now() - startTime3;\r\n      \r\n      console.log('âœ… Respuesta de API recibida exitosamente');\r\n      await logChatMetric('gemini_api', latency3, true, user?.uid);\r\n      \r\n      const botMessage = {\r\n        id: messages.length + 2,\r\n        text: response,\r\n        sender: 'bot',\r\n        isLocal: false,\r\n        timestamp: new Date().toISOString()\r\n      };\r\n\r\n      setMessages(prev => [...prev, botMessage]);\r\n      \r\n      // Guardar respuesta del bot de API\r\n      await saveChatMessage(response, 'bot', false);\r\n    } catch (error) {\r\n      console.error('âŒ Error completo de API:', error);\r\n      await logChatMetric('gemini_api', 0, false, user?.uid);\r\n      \r\n      // Mensajes de error mÃ¡s especÃ­ficos\r\n      let errorText = 'âš ï¸ **Error con la IA:**\\n\\n';\r\n      \r\n      if (error.message.includes('API Key invÃ¡lida')) {\r\n        errorText += 'ğŸ”‘ La API Key de Gemini no es vÃ¡lida.\\n\\n';\r\n      } else if (error.message.includes('LÃ­mite de peticiones')) {\r\n        errorText += 'â° Demasiadas peticiones. Espera un momento.\\n\\n';\r\n      } else if (error.message.includes('Network') || error.message.includes('Failed to fetch')) {\r\n        errorText += 'ğŸ“¡ Sin conexiÃ³n a internet.\\n\\n';\r\n      } else {\r\n        errorText += `Error: ${error.message}\\n\\n`;\r\n      }\r\n      \r\n      errorText += `ğŸ’¡ **Mientras tanto, prueba preguntando:**\\n`;\r\n      errorText += `â€¢ \"Â¿EstÃ¡ bien lo que comÃ­?\"\\n`;\r\n      errorText += `â€¢ \"Â¿QuÃ© tiene mÃ¡s proteÃ­nas?\"\\n`;\r\n      errorText += `â€¢ \"Â¿CuÃ¡nta agua tomar?\"\\n`;\r\n      errorText += `â€¢ \"Â¿Puedo tomar cerveza?\"\\n`;\r\n      errorText += `â€¢ \"Dame opciones para dÃ©ficit calÃ³rico\"\\n\\n`;\r\n      errorText += `âœ… Estas preguntas funcionan sin IA.`;\r\n      \r\n      const errorMessage = {\r\n        id: messages.length + 2,\r\n        text: errorText,\r\n        sender: 'bot'\r\n      };\r\n      \r\n      setMessages(prev => [...prev, errorMessage]);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleKeyPress = (e) => {\r\n    if (e.key === 'Enter' && !e.shiftKey) {\r\n      e.preventDefault();\r\n      handleSendMessage();\r\n    }\r\n  };\r\n\r\n  const handleInputChange = (e) => {\r\n    const value = e.target.value;\r\n    if (value.length <= MAX_CHARS) {\r\n      setInput(value);\r\n      setCharCount(value.length);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-pink-900 text-white p-4\">\r\n      {/* Header */}\r\n      <div className=\"max-w-7xl mx-auto mb-4 px-1\">\r\n        <div className=\"flex items-center gap-4\">\r\n          <motion.button\r\n            whileHover={{ scale: 1.1 }}\r\n            whileTap={{ scale: 0.9 }}\r\n            onClick={onBack}\r\n            className=\"p-2 bg-white/10 backdrop-blur-sm rounded-lg hover:bg-white/20 transition-colors\"\r\n          >\r\n            <ArrowLeft size={24} />\r\n          </motion.button>\r\n          {/* Toggle sidebar on mobile */}\r\n          <motion.button\r\n            whileHover={{ scale: 1.05 }}\r\n            whileTap={{ scale: 0.95 }}\r\n            onClick={() => setShowSidebar(prev => !prev)}\r\n            className=\"p-2 bg-white/10 backdrop-blur-sm rounded-lg hover:bg-white/20 transition-colors md:hidden\"\r\n            aria-label=\"Toggle historial\"\r\n          >\r\n            <MessageCircle size={20} />\r\n          </motion.button>\r\n          <div className=\"flex items-center gap-3\">\r\n            <div className=\"p-3 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl\">\r\n              <MessageSquare size={24} />\r\n            </div>\r\n            <div>\r\n              <h1 className=\"text-2xl font-bold\">Asistente IA</h1>\r\n              <p className=\"text-sm opacity-75\">Con historial de conversaciones</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Main Container con Sidebar */}\r\n      <div className=\"max-w-7xl mx-auto flex flex-col md:flex-row gap-4 h-auto md:h-[calc(100vh-200px)]\">\r\n        \r\n        {/* Sidebar - Historial */}\r\n        {showSidebar && (\r\n          <motion.div\r\n            initial={{ x: -100, opacity: 0 }}\r\n            animate={{ x: 0, opacity: 1 }}\r\n            className=\"w-full md:w-64 bg-black/30 backdrop-blur-sm rounded-2xl p-4 flex flex-col\"\r\n          >\r\n            {/* BotÃ³n Nueva ConversaciÃ³n */}\r\n            <motion.button\r\n              whileHover={{ scale: 1.02 }}\r\n              whileTap={{ scale: 0.98 }}\r\n              onClick={createNewConversation}\r\n              className=\"w-full p-3 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg mb-4 flex items-center gap-2 justify-center font-medium\"\r\n            >\r\n              <Plus size={20} />\r\n              Nueva ConversaciÃ³n\r\n            </motion.button>\r\n            \r\n            {/* Lista de Conversaciones */}\r\n            <div className=\"flex-1 overflow-y-auto space-y-2\">\r\n              {conversations.map((convo) => (\r\n                <div\r\n                  key={convo.id}\r\n                  className={`p-3 rounded-lg cursor-pointer flex items-center justify-between group transition-all ${\r\n                    activeConversationId === convo.id\r\n                      ? 'bg-white/20'\r\n                      : 'bg-white/5 hover:bg-white/10'\r\n                  }`}\r\n                  onClick={() => loadConversationMessages(convo.id)}\r\n                >\r\n                  <div className=\"flex-1 min-w-0\">\r\n                    <div className=\"flex items-center gap-2 mb-1\">\r\n                      <MessageCircle size={14} className=\"flex-shrink-0\" />\r\n                      <p className=\"text-sm font-medium truncate\">{convo.title}</p>\r\n                    </div>\r\n                    <p className=\"text-xs opacity-50\">\r\n                      {convo.messageCount || 0} mensajes\r\n                    </p>\r\n                  </div>\r\n                  \r\n                  <button\r\n                    onClick={(e) => {\r\n                      e.stopPropagation();\r\n                      deleteConversation(convo.id);\r\n                    }}\r\n                    className=\"opacity-0 group-hover:opacity-100 p-1 hover:bg-red-500/20 rounded transition-all\"\r\n                  >\r\n                    <Trash2 size={16} className=\"text-red-400\" />\r\n                  </button>\r\n                </div>\r\n              ))}\r\n            </div>\r\n\r\n            {/* Preferencias del Usuario */}\r\n            {userPreferences && userPreferences.favoriteFoods && userPreferences.favoriteFoods.length > 0 && (\r\n              <div className=\"mt-4 pt-4 border-t border-white/10\">\r\n                <div className=\"text-xs font-semibold mb-2 opacity-75\">ğŸ¯ Tus Favoritos</div>\r\n                <div className=\"space-y-1\">\r\n                  {userPreferences.favoriteFoods.slice(0, 3).map((food, index) => (\r\n                    <div key={index} className=\"text-xs bg-white/5 rounded-lg p-2\">\r\n                      <div className=\"flex justify-between\">\r\n                        <span className=\"truncate\">{food.name}</span>\r\n                        <span className=\"text-purple-300 ml-2\">{food.percentage}%</span>\r\n                      </div>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n                {userPreferences.dietType && (\r\n                  <div className=\"mt-2 text-xs bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-lg p-2\">\r\n                    <span className=\"opacity-75\">Dieta: </span>\r\n                    <span className=\"font-medium\">{userPreferences.dietType}</span>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            )}\r\n          </motion.div>\r\n        )}\r\n\r\n        {/* Chat Area */}\r\n        <div className=\"flex-1 bg-white/10 backdrop-blur-lg rounded-2xl shadow-2xl p-3 sm:p-4 flex flex-col\">\r\n          {/* Messages Area */}\r\n          <div className=\"flex-1 overflow-y-auto mb-4 space-y-4 px-1\">\r\n            <AnimatePresence>\r\n              {messages.map((message) => (\r\n                <motion.div\r\n                  key={message.id}\r\n                  initial={{ opacity: 0, y: 20 }}\r\n                  animate={{ opacity: 1, y: 0 }}\r\n                  exit={{ opacity: 0, y: -20 }}\r\n                  className={`flex ${message.sender === 'user' ? 'justify-end' : 'justify-start'}`}\r\n                >\r\n                  <div\r\n                    className={`max-w-[90%] sm:max-w-[80%] p-3 sm:p-4 rounded-2xl ${\r\n                      message.sender === 'user'\r\n                        ? 'bg-gradient-to-r from-purple-500 to-pink-500'\r\n                        : 'bg-white/20 backdrop-blur-sm'\r\n                    }`}\r\n                  >\r\n                    {message.sender === 'bot' && (\r\n                      <div className=\"flex items-center gap-2 mb-2 opacity-75\">\r\n                        <Sparkles size={16} />\r\n                        <span className=\"text-xs\">\r\n                          {message.isLocal ? 'Respuesta Local' : 'IA (Gemini)'}\r\n                        </span>\r\n                      </div>\r\n                    )}\r\n                    <div className=\"whitespace-pre-wrap prose prose-invert max-w-none\">\r\n                      <ReactMarkdown remarkPlugins={[remarkGfm]}>{message.text || ''}</ReactMarkdown>\r\n                    </div>\r\n                  </div>\r\n                </motion.div>\r\n              ))}\r\n            </AnimatePresence>\r\n\r\n            {isLoading && (\r\n              <motion.div\r\n                initial={{ opacity: 0 }}\r\n                animate={{ opacity: 1 }}\r\n                className=\"flex justify-start\"\r\n              >\r\n                <div className=\"bg-white/20 backdrop-blur-sm p-4 rounded-2xl\">\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <div className=\"flex gap-1\">\r\n                      <div className=\"w-2 h-2 bg-white rounded-full animate-bounce\"></div>\r\n                      <div className=\"w-2 h-2 bg-white rounded-full animate-bounce\" style={{ animationDelay: '0.1s' }}></div>\r\n                      <div className=\"w-2 h-2 bg-white rounded-full animate-bounce\" style={{ animationDelay: '0.2s' }}></div>\r\n                    </div>\r\n                    <span className=\"text-sm opacity-75\">Pensando...</span>\r\n                  </div>\r\n                </div>\r\n              </motion.div>\r\n            )}\r\n\r\n            <div ref={messagesEndRef} />\r\n          </div>\r\n\r\n          {/* Input Area */}\r\n          <div className=\"space-y-2\">\r\n            {/* Contador de caracteres */}\r\n            <div className=\"flex justify-between items-center px-2\">\r\n              <span className={`text-xs ${charCount > MAX_CHARS * 0.9 ? 'text-red-400' : 'opacity-50'}`}>\r\n                {charCount}/{MAX_CHARS} caracteres\r\n              </span>\r\n              {charCount > MAX_CHARS * 0.9 && (\r\n                <span className=\"text-xs text-red-400\">âš ï¸ Cerca del lÃ­mite</span>\r\n              )}\r\n            </div>\r\n            \r\n            <div className=\"flex flex-col sm:flex-row gap-2\">\r\n              <textarea\r\n                value={input}\r\n                onChange={handleInputChange}\r\n                onKeyPress={handleKeyPress}\r\n                placeholder=\"Escribe tu mensaje... (mÃ¡ximo 500 caracteres)\"\r\n                className=\"flex-1 p-2 sm:p-4 bg-white/10 backdrop-blur-sm border border-white/20 rounded-xl text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none\"\r\n                rows={2}\r\n                disabled={isLoading}\r\n                maxLength={MAX_CHARS}\r\n              />\r\n              <motion.button\r\n                whileHover={{ scale: 1.05 }}\r\n                whileTap={{ scale: 0.95 }}\r\n                onClick={handleSendMessage}\r\n                disabled={isLoading || !input.trim() || charCount > MAX_CHARS}\r\n                className=\"p-2 sm:p-4 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl hover:from-purple-600 hover:to-pink-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed self-end flex items-center justify-center\"\r\n              >\r\n                <Send className=\"w-5 h-5 sm:w-6 sm:h-6\" />\r\n              </motion.button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default Chatbot;\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}